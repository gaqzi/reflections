<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <link rel="stylesheet" type="text/css" href="./theme/css/elegant.prod.9e9d5ce754.css" media="screen">
        <link rel="stylesheet" type="text/css" href="./theme/css/custom.css" media="screen">

        <link rel="dns-prefetch" href="//fonts.googleapis.com">
        <link rel="preconnect" href="https://fonts.gstatic.com/" crossorigin>

        <meta name="google-site-verification" content="<meta name='google-site-verification' content='N5QEPRj-LpgoEY0Hf3uVMmZq8kjDwTFjd54IgvLmRBc' />" />        <meta name="author" content="Redowan Delowar" />

        <meta name="description" content="Recently, fell into this trap as I wanted to speed up a slow instance method by caching it. When you decorate an instance method with functools.lru_cache decorator, the instances of the class encapsulating that method never get garbage collected within the lifetime of the process holding them. Let&#39;s consider …
" />
        <meta property="og:type" content="article" />
        <meta name="twitter:card" content="summary">

<meta name="keywords" content="Python, python, " />

<meta property="og:title" content="Don&#39;t wrap instance methods with &#39;functools.lru_cache&#39; decorator in Python "/>
<meta property="og:url" content="./dont-wrap-instance-methods-with-functoolslru_cache-decorator-in-python.html" />
<meta property="og:description" content="Recently, fell into this trap as I wanted to speed up a slow instance method by caching it. When you decorate an instance method with functools.lru_cache decorator, the instances of the class encapsulating that method never get garbage collected within the lifetime of the process holding them. Let&#39;s consider …" />
<meta property="og:site_name" content="Redowan&#39;s Reflections" />
<meta property="og:article:author" content="Redowan Delowar" />
<meta property="og:article:published_time" content="2022-01-15T00:00:00+06:00" />
<meta name="twitter:title" content="Don&#39;t wrap instance methods with &#39;functools.lru_cache&#39; decorator in Python ">
<meta name="twitter:description" content="Recently, fell into this trap as I wanted to speed up a slow instance method by caching it. When you decorate an instance method with functools.lru_cache decorator, the instances of the class encapsulating that method never get garbage collected within the lifetime of the process holding them. Let&#39;s consider …">
<meta property="og:image" content="https://user-images.githubusercontent.com/30027932/149235389-c6b85b40-5515-4de4-a922-7b0f91efd0cf.png" />
<meta name="twitter:image" content="https://user-images.githubusercontent.com/30027932/149235389-c6b85b40-5515-4de4-a922-7b0f91efd0cf.png" >

        <title>Don&#39;t wrap instance methods with &#39;functools.lru_cache&#39; decorator in Python  · Redowan&#39;s Reflections
</title>
        <link href="https://rednafi.github.io/reflections/feeds/all.atom.xml" type="application/atom+xml" rel="alternate" title="Redowan&#39;s Reflections - Full Atom Feed" />

<script>
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
     (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
     m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
     })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
    ga('create', 'UA-217287505-1', 'auto');
    ga('send', 'pageview');
</script>


    </head>
    <body>
        <div id="content">
            <div class="navbar navbar-static-top">
                <div class="navbar-inner">
                    <div class="container-fluid">
                        <a class="btn btn-navbar" data-toggle="collapse" data-target=".nav-collapse">
                            <span class="icon-bar"></span>
                            <span class="icon-bar"></span>
                            <span class="icon-bar"></span>
                        </a>
                        <a class="brand" href="./"><span class=site-name>Redowan's Reflections</span></a>
                        <div class="nav-collapse collapse">
                            <ul class="nav pull-right top-menu">
                                <li >
                                    <a href=
                                       .
                                    >Home</a>
                                </li>
                                <li ><a href="./pages/contact.html">Contact</a></li>
                                <li ><a href="./categories.html">Categories</a></li>
                                <li ><a href="./tags.html">Tags</a></li>
                                <li ><a href="./archives.html">Archives</a></li>
                                <li>
                                  <form action="https://www.google.com/search" class="navbar-search" method="get" name="searchform" target="_blank">
                                    <input name="sitesearch" type="hidden"
                                    value="rednafi.github.io/reflections">
                                    <input autocomplete="on" class="search-query" name="q" placeholder="Search"
                                    required="required"  type="text">
                                    <input type="submit" value="Search" style="visibility: hidden;" /></form>
                                  </form>
                                </li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
            <div class="container-fluid">
                <div class="row-fluid">
                    <div class="span1"></div>
                    <div class="span10">
<article itemscope>
<div class="row-fluid">
    <header class="page-header span10 offset2">
        <h1>
            <a href="./dont-wrap-instance-methods-with-functoolslru_cache-decorator-in-python.html">
                Don't wrap instance methods with 'functools.lru_cache' decorator in Python
            </a>
        </h1>
    </header>
</div>

<div class="row-fluid">
        <div class="span8 offset2 article-content">
            
            <p>Recently, fell into this trap as I wanted to speed up a slow instance method by caching
it.</p>
<blockquote>
<p>When you decorate an instance method with <code>functools.lru_cache</code> decorator, the
instances of the class encapsulating that method never get garbage collected within
the lifetime of the process holding them.</p>
</blockquote>
<p>Let's consider this example:</p>
<div class="highlight"><pre><span></span><code><span class="c1"># src.py</span>
<span class="kn">import</span> <span class="nn">functools</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">TypeVar</span>

<span class="n">Number</span> <span class="o">=</span> <span class="n">TypeVar</span><span class="p">(</span><span class="s2">&quot;Number&quot;</span><span class="p">,</span> <span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">,</span> <span class="nb">complex</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">SlowAdder</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">delay</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">delay</span> <span class="o">=</span> <span class="n">delay</span>

    <span class="nd">@functools</span><span class="o">.</span><span class="n">lru_cache</span>
    <span class="k">def</span> <span class="nf">calculate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">:</span> <span class="n">Number</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Number</span><span class="p">:</span>
        <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">delay</span><span class="p">)</span>
        <span class="k">return</span> <span class="nb">sum</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__del__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Deleting instance ...&quot;</span><span class="p">)</span>


<span class="c1"># Create a SlowAdder instance.</span>
<span class="n">slow_adder</span> <span class="o">=</span> <span class="n">SlowAdder</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>

<span class="c1"># Measure performance.</span>
<span class="n">start_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">perf_counter</span><span class="p">()</span>
<span class="c1"># ----------------------------------------------</span>
<span class="n">result</span> <span class="o">=</span> <span class="n">slow_adder</span><span class="o">.</span><span class="n">calculate</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
<span class="c1"># ----------------------------------------------</span>
<span class="n">end_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">perf_counter</span><span class="p">()</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Calculation took </span><span class="si">{</span><span class="n">end_time</span><span class="o">-</span><span class="n">start_time</span><span class="si">}</span><span class="s2"> seconds, result: </span><span class="si">{</span><span class="n">result</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span>


<span class="n">start_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">perf_counter</span><span class="p">()</span>
<span class="c1"># ----------------------------------------------</span>
<span class="n">result</span> <span class="o">=</span> <span class="n">slow_adder</span><span class="o">.</span><span class="n">calculate</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
<span class="c1"># ----------------------------------------------</span>
<span class="n">end_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">perf_counter</span><span class="p">()</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Calculation took </span><span class="si">{</span><span class="n">end_time</span><span class="o">-</span><span class="n">start_time</span><span class="si">}</span><span class="s2"> seconds, result: </span><span class="si">{</span><span class="n">result</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span>
</code></pre></div>

<p>Here, I've created a simple <code>SlowAdder</code> class that accepts a <code>delay</code> value; then it
sleeps for <code>delay</code> seconds and calculates the sum of the inputs in the <code>calculate</code>
method. To avoid this slow recalculation for the same arguments, the <code>calculate</code> method
was wrapped in the <code>lru_cache</code> decorator. The <code>__del__</code> method notifies us when the
garbage collection has successfully cleaned up instances of the class.</p>
<p>If you run this program, it'll print this:</p>
<div class="highlight"><pre><span></span><code>Calculation took 2.0021052900010545 seconds, result: 3.
Calculation took 5.632002284983173e-06 seconds, result: 3.
Deleting instance ...
</code></pre></div>

<p>You can see that the <code>lru_cache</code> decorator is doing its job. The second call to the
<code>calculate</code> method with the same argument took noticeably less time compared to the
first one. In the second case, the <code>lru_cache</code> decorator is just doing a simple
dictionary lookup. This is all good but the instances of the <code>ShowAdder</code> class never get
garbage collected in the lifetime of the program. Let's prove that in the next section.</p>
<h2>Garbage collector can't clear up the affected instances</h2>
<p>If you execute the above snippet with an <code>-i</code> flag, we can interactively prove that no
garbage collection takes place. Let's do it:</p>
<div class="highlight"><pre><span></span><code><span class="err">$</span> <span class="n">python</span> <span class="o">-</span><span class="n">i</span> <span class="n">src</span><span class="o">.</span><span class="n">py</span>
<span class="n">Calculation</span> <span class="n">took</span> <span class="mf">2.002104839997628</span> <span class="n">seconds</span><span class="p">,</span> <span class="n">result</span><span class="p">:</span> <span class="mf">3.</span>
<span class="n">Calculation</span> <span class="n">took</span> <span class="mf">5.566998879658058e-06</span> <span class="n">seconds</span><span class="p">,</span> <span class="n">result</span><span class="p">:</span> <span class="mf">3.</span>
<span class="o">&gt;&gt;&gt;</span> <span class="kn">import</span> <span class="nn">gc</span>
<span class="o">&gt;&gt;&gt;</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">slow_adder</span><span class="o">.</span><span class="n">calculate</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span>
<span class="mi">3</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">slow_adder</span> <span class="o">=</span> <span class="kc">None</span>
<span class="o">&gt;&gt;&gt;</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">gc</span><span class="o">.</span><span class="n">collect</span><span class="p">()</span>
<span class="mi">0</span>
<span class="o">&gt;&gt;&gt;</span>
</code></pre></div>

<p>Here on the REPL, you can see that I've reassigned <code>slow_adder</code> to None and then
explicitly triggered the garbage collector. However, we don't see the message in the
<code>__del__</code> method printed here and the output of <code>gc.collect()</code> is 0. This implies that
something is holding a reference to the <code>slow_adder</code> instance and the garbage collector
can't clear up the object. Let's inspect who has that reference:</p>
<div class="highlight"><pre><span></span><code>$ python -i src.py
Calculation took <span class="m">2</span>.00233274600032 seconds, result: <span class="m">3</span>.
Calculation took <span class="m">5</span>.453999619930983e-06 seconds, result: <span class="m">3</span>.
&gt;&gt;&gt; slow_adder.calculate.cache_info<span class="o">()</span>
CacheInfo<span class="o">(</span><span class="nv">hits</span><span class="o">=</span><span class="m">1</span>, <span class="nv">misses</span><span class="o">=</span><span class="m">1</span>, <span class="nv">maxsize</span><span class="o">=</span><span class="m">128</span>, <span class="nv">currsize</span><span class="o">=</span><span class="m">1</span><span class="o">)</span>
&gt;&gt;&gt; slow_adder.calculate<span class="o">(</span><span class="m">1</span>,2<span class="o">)</span>
<span class="m">3</span>
&gt;&gt;&gt; slow_adder.calculate.cache_info<span class="o">()</span>
CacheInfo<span class="o">(</span><span class="nv">hits</span><span class="o">=</span><span class="m">2</span>, <span class="nv">misses</span><span class="o">=</span><span class="m">1</span>, <span class="nv">maxsize</span><span class="o">=</span><span class="m">128</span>, <span class="nv">currsize</span><span class="o">=</span><span class="m">1</span><span class="o">)</span>
&gt;&gt;&gt; slow_adder.calculate.cache_clear<span class="o">()</span>
&gt;&gt;&gt; <span class="nv">slow_adder</span> <span class="o">=</span> None
Deleting instance ...
&gt;&gt;&gt;
</code></pre></div>

<p>The <code>cache_info()</code> is showing that the cache container keeps a reference to the instance
until it gets cleared. When I manually cleared the cache and reassigned the variable
<code>slow_adder</code> to <code>None</code>, only then did the garbage collector remove the instance. By
default, the size of the <code>lru_cache</code> is 128 but if I had applied
<code>lru_cache(maxsize=None)</code>, that would've kept the cache forever and the garbage
collector would wait for the reference count to drop to zero but that'd never happen
within the lifetime of the process.</p>
<p>This can be dangerous if you create millions of instances and they don't get garbage
collected naturally. It can overflow your working memory and cause the process to crash!
I accidentally did it where the infected class was being instantiated millions of times
via HTTP API requests.</p>
<h2>The solution</h2>
<p>To solve this, we'll have to make the cache containers local to the instances so that
the reference from cache to the instance gets scraped off with the instance. Here's how
you can do that:</p>
<div class="highlight"><pre><span></span><code><span class="c1"># src_2.py</span>
<span class="kn">import</span> <span class="nn">functools</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">TypeVar</span>

<span class="n">Number</span> <span class="o">=</span> <span class="n">TypeVar</span><span class="p">(</span><span class="s2">&quot;Number&quot;</span><span class="p">,</span> <span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">,</span> <span class="nb">complex</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">SlowAdder</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">delay</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">delay</span> <span class="o">=</span> <span class="n">delay</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">calculate</span> <span class="o">=</span> <span class="n">functools</span><span class="o">.</span><span class="n">lru_cache</span><span class="p">()(</span><span class="bp">self</span><span class="o">.</span><span class="n">_calculate</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_calculate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">:</span> <span class="n">Number</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Number</span><span class="p">:</span>
        <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">delay</span><span class="p">)</span>
        <span class="k">return</span> <span class="nb">sum</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__del__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Deleting instance ...&quot;</span><span class="p">)</span>
</code></pre></div>

<p>The only difference here is—instead of decorating the method directly, I called the
decorator function on the <code>_calculate</code> method just as a regular function and saved the
result as an instance variable named <code>calculate</code>. The instances of this class get
garbage collected as usual.</p>
<div class="highlight"><pre><span></span><code><span class="err">$</span> <span class="n">python</span> <span class="o">-</span><span class="n">i</span> <span class="n">src</span><span class="o">.</span><span class="n">py</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">slow_adder</span> <span class="o">=</span> <span class="n">SlowAdder</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">slow_adder</span><span class="o">.</span><span class="n">calculate</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span>
<span class="mi">3</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">slow_adder</span><span class="o">.</span><span class="n">calculate</span><span class="o">.</span><span class="n">cache_info</span><span class="p">()</span>
<span class="n">CacheInfo</span><span class="p">(</span><span class="n">hits</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">misses</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">maxsize</span><span class="o">=</span><span class="mi">128</span><span class="p">,</span> <span class="n">currsize</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="o">&gt;&gt;&gt;</span> <span class="kn">import</span> <span class="nn">gc</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">slow_adder</span> <span class="o">=</span> <span class="kc">None</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">gc</span><span class="o">.</span><span class="n">collect</span><span class="p">()</span>
<span class="n">Deleting</span> <span class="n">instance</span> <span class="o">...</span>
<span class="mi">11</span>
</code></pre></div>

<p>Notice that this time, clearing out the cache wasn't necessary. I had to call
<code>gc.collect()</code> to invoke explicit garbage collection. That's because this shenanigan
creates cyclical references and the GC needs to do some special magic to clear the
memory. In real code, Python interpreter will clean this up for you in the background
without you having to call the GC.</p>
<h2>The self dilemma</h2>
<p>Even after applying the solution above, a weird thing happens in the case of instance
methods. Let's run the <code>src_2.py</code> script interactively to demonstrate that:</p>
<div class="highlight"><pre><span></span><code>$ python -i src_2.py
&gt;&gt;&gt; <span class="nv">slow_adder</span> <span class="o">=</span> SlowAdder<span class="o">(</span><span class="m">2</span><span class="o">)</span>
&gt;&gt;&gt; slow_adder.calculate<span class="o">(</span><span class="m">1</span>,2<span class="o">)</span>
&gt;&gt;&gt; slow_adder
&lt;__main__.SlowAdder object at 0x7f92595f9b40&gt;
&gt;&gt;&gt; <span class="nv">slow_adder_2</span> <span class="o">=</span> SlowAdder<span class="o">(</span><span class="m">2</span><span class="o">)</span>
&gt;&gt;&gt; slow_adder_2.calculate<span class="o">(</span><span class="m">1</span>,2<span class="o">)</span>
<span class="m">3</span>
&gt;&gt;&gt; slow_adder.calculate.cache_info<span class="o">()</span>
CacheInfo<span class="o">(</span><span class="nv">hits</span><span class="o">=</span><span class="m">1</span>, <span class="nv">misses</span><span class="o">=</span><span class="m">2</span>, <span class="nv">maxsize</span><span class="o">=</span><span class="m">128</span>, <span class="nv">currsize</span><span class="o">=</span><span class="m">2</span><span class="o">)</span>
&gt;&gt;&gt; slow_adder_2.calculate.cache_info<span class="o">()</span>
CacheInfo<span class="o">(</span><span class="nv">hits</span><span class="o">=</span><span class="m">1</span>, <span class="nv">misses</span><span class="o">=</span><span class="m">2</span>, <span class="nv">maxsize</span><span class="o">=</span><span class="m">128</span>, <span class="nv">currsize</span><span class="o">=</span><span class="m">2</span><span class="o">)</span>
&gt;&gt;&gt;
</code></pre></div>

<p>Here, I've created another instance of the <code>SlowAdder</code> class and called <code>calculate</code> with
the same arguments. But whenever I called the <code>calculate</code> method on the <code>slow_adder_2</code>
instance with the same parameters as before, the first time, it recalculated it instead
of returning the result from the cache. How come!</p>
<p>Underneath, the <code>lru_cache</code> decorator uses a dictionary to cache the calculated values.
A hash function is
<a href="https://github.com/python/cpython/blob/3.10/Lib/functools.py#L448">applied</a> to all the
parameters of the target function to build the key of the dictionary, and the value is
the return value of the function when those parameters are the inputs. This means, the
first argument <code>self</code> also gets included while building the cache key. However, for
different instances, this <code>self</code> object is going to be different and that makes the
hashed key of the cache different for every instance even if the other parameters are
the same.
    I</p>
<h2>But what about class methods &amp; static methods</h2>
<p>Class methods and static methods don't suffer from the above issues as they don't have
any ties to their respective instances. In their case, the cache container is local to
the class, not the instances. Here, you can stack the <code>lru_cache</code> decorator as usual.
Let's demonstrate that for <code>classmethod</code> first:</p>
<div class="highlight"><pre><span></span><code><span class="c1"># src_3.py</span>
<span class="kn">import</span> <span class="nn">functools</span>
<span class="kn">import</span> <span class="nn">time</span>


<span class="k">class</span> <span class="nc">Foo</span><span class="p">:</span>
    <span class="nd">@classmethod</span>
    <span class="nd">@functools</span><span class="o">.</span><span class="n">lru_cache</span>
    <span class="k">def</span> <span class="nf">bar</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">delay</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
        <span class="c1"># Do something with the cls.</span>
        <span class="bp">cls</span><span class="o">.</span><span class="n">delay</span> <span class="o">=</span> <span class="n">delay</span>
        <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="n">delay</span><span class="p">)</span>
        <span class="k">return</span> <span class="mi">42</span>

    <span class="k">def</span> <span class="fm">__del__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Deleting instance ...&quot;</span><span class="p">)</span>


<span class="n">foo_1</span> <span class="o">=</span> <span class="n">Foo</span><span class="p">()</span>
<span class="n">foo_2</span> <span class="o">=</span> <span class="n">Foo</span><span class="p">()</span>


<span class="n">start_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">perf_counter</span><span class="p">()</span>
<span class="c1"># ----------------------------------------------</span>
<span class="n">result</span> <span class="o">=</span> <span class="n">foo_1</span><span class="o">.</span><span class="n">bar</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
<span class="c1"># ----------------------------------------------</span>
<span class="n">end_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">perf_counter</span><span class="p">()</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Calculation took </span><span class="si">{</span><span class="n">end_time</span> <span class="o">-</span> <span class="n">start_time</span><span class="si">}</span><span class="s2"> seconds, result: </span><span class="si">{</span><span class="n">result</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span>


<span class="n">start_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">perf_counter</span><span class="p">()</span>
<span class="c1"># ----------------------------------------------</span>
<span class="n">result</span> <span class="o">=</span> <span class="n">foo_2</span><span class="o">.</span><span class="n">bar</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
<span class="c1"># ----------------------------------------------</span>
<span class="n">end_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">perf_counter</span><span class="p">()</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Calculation took </span><span class="si">{</span><span class="n">end_time</span> <span class="o">-</span> <span class="n">start_time</span><span class="si">}</span><span class="s2"> seconds, result: </span><span class="si">{</span><span class="n">result</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span>
</code></pre></div>

<p>You can inspect the garbage collection behavior here:</p>
<div class="highlight"><pre><span></span><code>$ python src_3.py
Calculation took <span class="m">2</span>.0022965140015003 seconds, result: <span class="m">42</span>.
Calculation took <span class="m">4</span>.4819971662946045e-06 seconds, result: <span class="m">42</span>.
&gt;&gt;&gt; <span class="nv">foo_1</span> <span class="o">=</span> None
Deleting instance ...
&gt;&gt;&gt;
</code></pre></div>

<p>Static methods behave exactly the same. You can use the <code>lru_cache</code> decorator in similar
fashion as below:</p>
<div class="highlight"><pre><span></span><code><span class="kn">import</span> <span class="nn">functools</span>
<span class="kn">import</span> <span class="nn">time</span>


<span class="k">class</span> <span class="nc">Foo</span><span class="p">:</span>
    <span class="nd">@staticmethod</span>
    <span class="nd">@functools</span><span class="o">.</span><span class="n">lru_cache</span>
    <span class="k">def</span> <span class="nf">bar</span><span class="p">(</span><span class="n">delay</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
        <span class="k">return</span> <span class="mi">42</span>

    <span class="k">def</span> <span class="fm">__del__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Deleting instance ...&quot;</span><span class="p">)</span>
</code></pre></div>

<h2>References</h2>
<ul>
<li><a href="https://docs.python.org/3/library/functools.html#functools.lru_cache">functools.lru_cache - Python Docs</a></li>
<li><a href="https://www.youtube.com/watch?v=sVjtp6tGo0g">Don't lru_cache methods! (intermediate) anthony explains #382</a></li>
<li><a href="https://stackoverflow.com/questions/70409673/python-lru-cache-in-a-class-disregards-maxsize-limit-when-decorated-with-a-stati">Python LRU cache in a class disregards maxsize limit when decorated with a staticmethod or classmethod decorator</a></li>
</ul>


             
 
            
            
            







            <hr/>
        </div>
        <section id="article-sidebar" class="span2">
            <h4>Published</h4>
            <time itemprop="dateCreated" datetime="2022-01-15T00:00:00+06:00">Sat 15 January 2022</time>
            <h4>Category</h4>
            <a class="category-link" href="./categories.html#python-ref">python</a>
            <h4>Tags</h4>
            <ul class="list-of-tags tags-in-article">
                <li><a href="./tags.html#python-ref">Python
                    <span class="superscript">58</span>
</a></li>
            </ul>
<h4>Contact</h4>
<div id="sidebar-social-link">
    <a href="mailto:redowan.nafi@gmail.com" title="" target="_blank" rel="nofollow noopener noreferrer">
        <svg xmlns="http://www.w3.org/2000/svg" aria-label="Mail" role="img" viewBox="0 0 512 512"><rect width="512" height="512" rx="15%" fill="#328cff"/><path d="m250 186c-46 0-69 35-69 74 0 44 29 72 68 72 43 0 73-32 73-75 0-44-34-71-72-71zm-1-37c30 0 57 13 77 33 0-22 35-22 35 1v150c-1 10 10 16 16 9 25-25 54-128-14-187-64-56-149-47-195-15-48 33-79 107-49 175 33 76 126 99 182 76 28-12 41 26 12 39-45 19-168 17-225-82-38-68-36-185 67-248 78-46 182-33 244 32 66 69 62 197-2 246-28 23-71 1-71-32v-11c-20 20-47 32-77 32-57 0-108-51-108-108 0-58 51-110 108-110" fill="#fff"/></svg>
    </a>
    <a href="https://github.com/rednafi" title="" target="_blank" rel="nofollow noopener noreferrer">
        <svg xmlns="http://www.w3.org/2000/svg" aria-label="GitHub" role="img" viewBox="0 0 512 512"><rect width="512" height="512" rx="15%" fill="#1B1817"/><path fill="#fff" d="M335 499c14 0 12 17 12 17H165s-2-17 12-17c13 0 16-6 16-12l-1-50c-71 16-86-28-86-28-12-30-28-37-28-37-24-16 1-16 1-16 26 2 40 26 40 26 22 39 59 28 74 22 2-17 9-28 16-35-57-6-116-28-116-126 0-28 10-51 26-69-3-6-11-32 3-67 0 0 21-7 70 26 42-12 86-12 128 0 49-33 70-26 70-26 14 35 6 61 3 67 16 18 26 41 26 69 0 98-60 120-117 126 10 8 18 24 18 48l-1 70c0 6 3 12 16 12z"/></svg>
    </a>
    <a href="https://twitter.com/rednafi" title="" target="_blank" rel="nofollow noopener noreferrer">
        <svg xmlns="http://www.w3.org/2000/svg" aria-label="Twitter" role="img" viewBox="0 0 512 512"><rect width="512" height="512" rx="15%" fill="#1da1f3"/><path fill="#fff" d="M437 152a72 72 0 0 1-40 12 72 72 0 0 0 32-40 72 72 0 0 1-45 17 72 72 0 0 0-122 65 200 200 0 0 1-145-74 72 72 0 0 0 22 94 72 72 0 0 1-32-7 72 72 0 0 0 56 69 72 72 0 0 1-32 1 72 72 0 0 0 67 50 200 200 0 0 1-105 29 200 200 0 0 0 309-179 200 200 0 0 0 35-37"/></svg>
    </a>
    <a href="https://www.goodreads.com/user/show/53485837-redowan-delowar" title="" target="_blank" rel="nofollow noopener noreferrer">
        <svg height="512" viewBox="0 0 512 512" width="512" xmlns="http://www.w3.org/2000/svg"><rect fill="#EAE6CF" height="512" rx="64" width="512"/><path d="m254.92444 336.92444c43.2889-.36 74.07112-22.01333 92.33334-64.95111h.95556v65.48889c0 4.88-.32 12.44889-.95556 22.73333-1.30222 10.64445-4.78222 22.10223-10.42666 34.36889-5.65778 11.54667-14.79112 21.38667-27.37778 29.49778-12.44889 8.84-29.81778 13.44-52.12001 13.80444-21.48444 0-39.65333-5.59555-54.52444-16.77777-15.2-11.00889-24.08001-28.87111-26.65778-53.58667h-18.89778c1.93778 32.11111 12.18667 55.02667 30.76444 68.74222 18.08889 13.16445 41.04001 19.75556 68.83556 19.75556 27.45778 0 48.87112-5.14223 64.21778-15.43111 15.18223-9.92 26.08445-22.28445 32.71556-37.08 6.62222-14.79111 10.58222-28.86667 11.86667-42.21334.98222-13.35555 1.45778-22.91555 1.45778-28.68889v-270.088875h-18.90667v59.537775h-.95556c-7.27555-21.82667-19.30666-38.333335-36.12-49.524445-16.96-11.00445-35.70222-16.51111-56.21333-16.51111-35.72001.72444-62.85779 14.52444-81.43112 41.40889-19.07111 26.697775-28.59556 59.631105-28.59556 98.782195 0 40.23557 9.04445 73.52001 27.13334 99.86224 18.27555 26.88889 45.89778 40.51111 82.90222 40.87111zm-68.34222-224.89777c14.85333-24.359995 37.63111-36.986665 68.34222-37.888885 31.50223.90666 54.83556 13.17333 70.03556 36.808885 15.18223 23.64 22.77778 52.05331 22.77778 85.25331s-7.59555 61.43112-22.77778 84.70668c-15.2 24.72444-38.53333 37.34667-70.03556 37.88889-29.72889-.54667-52.36-12.81778-67.86222-36.80889-15.67556-23.27556-23.50667-51.87112-23.50667-85.79112-.004-31.75556 7.67111-59.81332 23.02667-84.16887z" fill="#743901"/></svg>
    </a>
    <a href="/reflections/feeds/all.atom.xml" title="" target="_blank" rel="nofollow noopener noreferrer">
        <svg xmlns="http://www.w3.org/2000/svg" aria-label="RSS" role="img" viewBox="0 0 512 512"><rect width="512" height="512" rx="15%" fill="#f80"/><circle cx="145" cy="367" r="35" fill="#fff"/><path fill="none" stroke="#fff" stroke-width="60" d="M109 241c89 0 162 73 162 162M109 127c152 0 276 124 276 276"/></svg>
    </a>
</div>
            





            





        </section>
</div>
</article>
<!-- Root element of PhotoSwipe. Must have class pswp. -->
<div class="pswp" tabindex="-1" role="dialog" aria-hidden="true">

    <!-- Background of PhotoSwipe.
         It's a separate element as animating opacity is faster than rgba(). -->
    <div class="pswp__bg"></div>

    <!-- Slides wrapper with overflow:hidden. -->
    <div class="pswp__scroll-wrap">

        <!-- Container that holds slides.
            PhotoSwipe keeps only 3 of them in the DOM to save memory.
            Don't modify these 3 pswp__item elements, data is added later on. -->
        <div class="pswp__container">
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
        </div>

        <!-- Default (PhotoSwipeUI_Default) interface on top of sliding area. Can be changed. -->
        <div class="pswp__ui pswp__ui--hidden">

            <div class="pswp__top-bar">

                <!--  Controls are self-explanatory. Order can be changed. -->

                <div class="pswp__counter"></div>

                <button class="pswp__button pswp__button--close" title="Close (Esc)"></button>

                <button class="pswp__button pswp__button--share" title="Share"></button>

                <button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>

                <button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button>

                <!-- Preloader demo https://codepen.io/dimsemenov/pen/yyBWoR -->
                <!-- element will get class pswp__preloader--active when preloader is running -->
                <div class="pswp__preloader">
                    <div class="pswp__preloader__icn">
                      <div class="pswp__preloader__cut">
                        <div class="pswp__preloader__donut"></div>
                      </div>
                    </div>
                </div>
            </div>

            <div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap">
                <div class="pswp__share-tooltip"></div>
            </div>

            <button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
            </button>

            <button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)">
            </button>

            <div class="pswp__caption">
                <div class="pswp__caption__center"></div>
            </div>

        </div>

    </div>

</div>                    </div>
                    <div class="span1"></div>
                </div>
            </div>
        </div>
<footer>



    <div id="fpowered">

            © 2020-2022 • Redowan Delowar • All Rights Reserved


    </div>
</footer>            <script src="//code.jquery.com/jquery.min.js"></script>
        <script src="//netdna.bootstrapcdn.com/twitter-bootstrap/2.3.2/js/bootstrap.min.js"></script>
        <script src="./theme/js/elegant.prod.9e9d5ce754.js"></script>
        <script>
            function validateForm(query)
            {
                return (query.length > 0);
            }
        </script>

    <script>
    (function () {
        if (window.location.hash.match(/^#comment-\d+$/)) {
            $('#comment_thread').collapse('show');
        }
    })();
    window.onhashchange=function(){
        if (window.location.hash.match(/^#comment-\d+$/))
            window.location.reload(true);
    }
    $('#comment_thread').on('shown', function () {
        var link = document.getElementById('comment-accordion-toggle');
        var old_innerHTML = link.innerHTML;
        $(link).fadeOut(200, function() {
            $(this).text('Click here to hide comments').fadeIn(200);
        });
        $('#comment_thread').on('hidden', function () {
            $(link).fadeOut(200, function() {
                $(this).text(old_innerHTML).fadeIn(200);
            });
        })
    })
</script>

    </body>
    <!-- Theme: Elegant built for Pelican
        License : MIT -->
</html>