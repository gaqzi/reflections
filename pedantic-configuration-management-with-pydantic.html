<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <link rel="stylesheet" type="text/css" href="./theme/css/elegant.prod.9e9d5ce754.css" media="screen">
        <link rel="stylesheet" type="text/css" href="./theme/css/custom.css" media="screen">

        <link rel="dns-prefetch" href="//fonts.googleapis.com">
        <link rel="preconnect" href="https://fonts.gstatic.com/" crossorigin>

        <meta name="google-site-verification" content="<meta name='google-site-verification' content='N5QEPRj-LpgoEY0Hf3uVMmZq8kjDwTFjd54IgvLmRBc' />" />        <meta name="author" content="Redowan Delowar" />

        <meta name="description" content="Managing configurations in your Python applications isn&#39;t something you think about much often, until complexity starts to seep in and forces you to re-architect your initial approach. Ideally, your config management flow shouldn&#39;t change across different applications or as your application begins to grow in size and complexity. Even if …
" />
        <meta property="og:type" content="article" />
        <meta name="twitter:card" content="summary">

<meta name="keywords" content="Python, python, " />

<meta property="og:title" content="Pedantic configuration management with Pydantic "/>
<meta property="og:url" content="./pedantic-configuration-management-with-pydantic.html" />
<meta property="og:description" content="Managing configurations in your Python applications isn&#39;t something you think about much often, until complexity starts to seep in and forces you to re-architect your initial approach. Ideally, your config management flow shouldn&#39;t change across different applications or as your application begins to grow in size and complexity. Even if …" />
<meta property="og:site_name" content="Redowan&#39;s Reflections" />
<meta property="og:article:author" content="Redowan Delowar" />
<meta property="og:article:published_time" content="2020-07-13T00:00:00+06:00" />
<meta name="twitter:title" content="Pedantic configuration management with Pydantic ">
<meta name="twitter:description" content="Managing configurations in your Python applications isn&#39;t something you think about much often, until complexity starts to seep in and forces you to re-architect your initial approach. Ideally, your config management flow shouldn&#39;t change across different applications or as your application begins to grow in size and complexity. Even if …">
<meta property="og:image" content="https://user-images.githubusercontent.com/30027932/149235389-c6b85b40-5515-4de4-a922-7b0f91efd0cf.png" />
<meta name="twitter:image" content="https://user-images.githubusercontent.com/30027932/149235389-c6b85b40-5515-4de4-a922-7b0f91efd0cf.png" >

        <title>Pedantic configuration management with Pydantic  · Redowan&#39;s Reflections
</title>
        <link href="https://rednafi.github.io/reflections/feeds/all.atom.xml" type="application/atom+xml" rel="alternate" title="Redowan&#39;s Reflections - Full Atom Feed" />

<script>
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
     (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
     m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
     })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
    ga('create', 'UA-217287505-1', 'auto');
    ga('send', 'pageview');
</script>


    </head>
    <body>
        <div id="content">
            <div class="navbar navbar-static-top">
                <div class="navbar-inner">
                    <div class="container-fluid">
                        <a class="btn btn-navbar" data-toggle="collapse" data-target=".nav-collapse">
                            <span class="icon-bar"></span>
                            <span class="icon-bar"></span>
                            <span class="icon-bar"></span>
                        </a>
                        <a class="brand" href="./"><span class=site-name>Redowan's Reflections</span></a>
                        <div class="nav-collapse collapse">
                            <ul class="nav pull-right top-menu">
                                <li >
                                    <a href=
                                       .
                                    >Home</a>
                                </li>
                                <li ><a href="./pages/contact.html">Contact</a></li>
                                <li ><a href="./categories.html">Categories</a></li>
                                <li ><a href="./tags.html">Tags</a></li>
                                <li ><a href="./archives.html">Archives</a></li>
                                <li>
                                  <form action="https://www.google.com/search" class="navbar-search" method="get" name="searchform" target="_blank">
                                    <input name="sitesearch" type="hidden"
                                    value="rednafi.github.io/reflections">
                                    <input autocomplete="on" class="search-query" name="q" placeholder="Search"
                                    required="required"  type="text">
                                    <input type="submit" value="Search" style="visibility: hidden;" /></form>
                                  </form>
                                </li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
            <div class="container-fluid">
                <div class="row-fluid">
                    <div class="span1"></div>
                    <div class="span10">
<article itemscope>
<div class="row-fluid">
    <header class="page-header span10 offset2">
        <h1>
            <a href="./pedantic-configuration-management-with-pydantic.html">
                Pedantic configuration management with Pydantic
            </a>
        </h1>
    </header>
</div>

<div class="row-fluid">
        <div class="span8 offset2 article-content">
            
            <p>Managing configurations in your Python applications isn't something you think about much
often, until complexity starts to seep in and forces you to re-architect your initial
approach. Ideally, your config management flow shouldn't change across different
applications or as your application begins to grow in size and complexity. Even if
you're writing a library, there should be a consistent config management process that
scales up properly. Since I primarily spend my time writing data-analytics, data-science
applications and expose them using <a href="https://github.com/pallets/flask">Flask</a> or
<a href="https://github.com/tiangolo/fastapi">FastAPI</a> framework, I'll be tacking config
management from an application development perspective.</p>
<h2>Few ineffective approaches</h2>
<p>In the past, while exposing APIs with Flask, I used to use <code>.env</code>, <code>.flaskenv</code> and
<code>Config</code> class approach to manage configs which is pretty much a standard in the Flask
realm. However, it quickly became cumbersome to maintain and juggle between configs
depending on development, staging or production environments. There were additional
application specific global constants to deal with too. So I tried using <code>*.json</code>, <code>*.
yaml</code> or <code>*.toml</code> based config management approaches but those too, quickly turned into
a tangled mess. I was constantly accessing variables buried into 3-4 levels of nested
toml data structure and it wasn't pretty. Then there are config management libraries
like <a href="https://github.com/rochacbruno/dynaconf">Dynaconf</a> or
<a href="https://github.com/hynek/environ-config">environ-config</a> that aim to ameliorate the
issue. While these are all amazing tools but they also introduce their own custom
workflow that can feel over-engineered while dealing with maintenance and extension.</p>
<h2>A pragmatic wishlist</h2>
<p>I wanted to take a declarative approach while designing a config management pipleline
that will be <strong>modular</strong>, <strong>scalable</strong> and easy to <strong>maintain</strong>. To meet my
requirements, the system should be able to:</p>
<ul>
<li>Read configs from <code>.env</code> files and <em>shell environment</em> at the same time.</li>
<li>Handle dependency injection for introducing <em>passwords</em> or <em>secrets</em>.</li>
<li>Convert variable types automatically in the appropriate cases, e.g. string to integer
conversion.</li>
<li>Keep <em>development</em>, <em>staging</em> and <em>production</em> configs separate.</li>
<li>Switch between the different environments e.g development, staging effortlessly.</li>
<li>Inspect the <em>active</em> config values</li>
<li>Create arbitrarily nested config structure if required (Not encouraged though.
Constraints fosters creativity, remember?)</li>
</ul>
<h2>Building the config management pipeline</h2>
<h3>Preparation</h3>
<p>The code block that appears in this section is self contained. It should run without any
modifications. If you want to play along, then just spin up a Python virtual environment
and install <code>Pydantic</code> and <code>python-dotenv</code>. The following commands works on any <em>*nix</em>
based system:</p>
<div class="highlight"><pre><span></span><code>python3.10 -m venv venv
<span class="nb">source</span> venv/bin/activate
pip install pydantic python-dotenv
</code></pre></div>

<p>Make sure you have fairly a recent version of <code>Python 3</code> installed, preferably <code>Python 3.10</code>.
You might need to install <code>python3.10 venv</code>.</p>
<h3>Introduction to Pydantic</h3>
<p>To check off all the boxes of the wishlist above, I made a custom config management flow
using <a href="https://github.com/samuelcolvin/pydantic">Pydantic</a>,
<a href="https://github.com/theskumar/python-dotenv">python-dotenv</a> and the <code>.env</code> file.
Pydantic is a fantastic data validation library that can be used for validating and
implicitly converting data types using Python's type hints. Type hinting is a formal
solution to statically indicate the type of a value within your Python code. It was
specified in <a href="https://www.python.org/dev/peps/pep-0484/">PEP 484</a> and introduced in
Python 3.5. Let's define and validate the attributes of a class named <code>User</code>:</p>
<div class="highlight"><pre><span></span><code><span class="kn">from</span> <span class="nn">Pydantic</span> <span class="kn">import</span> <span class="n">BaseModel</span>


<span class="k">class</span> <span class="nc">User</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
    <span class="n">name</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">username</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">password</span><span class="p">:</span> <span class="nb">int</span>


<span class="n">user</span> <span class="o">=</span> <span class="n">User</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;Redowan Delowar&quot;</span><span class="p">,</span> <span class="n">username</span><span class="o">=</span><span class="s2">&quot;rednafi&quot;</span><span class="p">,</span> <span class="n">password</span><span class="o">=</span><span class="s2">&quot;123&quot;</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>
</code></pre></div>

<p>This will give you:</p>
<div class="highlight"><pre><span></span><code>&gt;&gt;&gt; User(name=&#39;Redowan Delowar&#39;, username=&#39;rednafi&#39;, password=123)
</code></pre></div>

<p>In the above example, I defined a simple class named <code>User</code> and used Pydantic for data
validation. Pydantic will make sure that the data you assign to the class attributes
conform with the types you've annotated. Notice, how I've assigned a string type data in
the <code>password</code> field and Pydantic converted it to integer type without complaining.
That's because the corresponding type annotation suggests that the <code>password</code> attribute
of the <code>User</code> class should be an integer. When implicit conversion is not possible or
the hinted value of an attribute doesn't conform to its assigned type, Pydantic will
throw a <code>ValidationError</code>.</p>
<h3>The orchestration</h3>
<p>Now let's see how you can orchestrate your config management flow with the tools
mentioned above. For simplicity, let's say you've  3 sets of configurations.</p>
<ol>
<li>Configs of your app's internal logic</li>
<li>Development environment configs</li>
<li>Production environment configs</li>
</ol>
<p>In this case, other than the first set of configs, all should go into the <code>.env</code> file.</p>
<p>I'll be using this <code>.env</code> file for demonstration. If you're following along, then go
ahead, create an empty <code>.env</code> file there and copy the variables mentioned below:</p>
<div class="highlight"><pre><span></span><code>#.env

ENV_STATE=&quot;dev&quot; # or prod

DEV_REDIS_HOST=&quot;127.0.0.1&quot;
DEV_REDIS_PORT=&quot;4000&quot;

PROD_REDIS_HOST=&quot;127.0.0.2&quot;
PROD_REDIS_PORT=&quot;5000&quot;
</code></pre></div>

<p>Notice how I've used the <code>DEV_</code> and <code>PROD_</code> prefixes before the environment specific
configs. These help you discern between the variables designated for different
environments.</p>
<blockquote>
<p>Configs related to your application's internal logic should either be explicitly
mentioned in the same <code>configs.py</code> or imported from a different <code>app_configs.py</code> file.
You shouldn't pollute your <code>.env</code> files with the internal global variables
necessitated by your application's core logic.</p>
</blockquote>
<p>Now let's dump the entire config orchestration and go though the building blocks one by
one:</p>
<div class="highlight"><pre><span></span><code><span class="c1"># configs.py</span>

<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Optional</span>

<span class="kn">from</span> <span class="nn">pydantic</span> <span class="kn">import</span> <span class="n">BaseSettings</span><span class="p">,</span> <span class="n">Field</span><span class="p">,</span> <span class="n">BaseModel</span>


<span class="k">class</span> <span class="nc">AppConfig</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Application configurations.&quot;&quot;&quot;</span>

    <span class="n">VAR_A</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">33</span>
    <span class="n">VAR_B</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">22.0</span>


<span class="k">class</span> <span class="nc">GlobalConfig</span><span class="p">(</span><span class="n">BaseSettings</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Global configurations.&quot;&quot;&quot;</span>

    <span class="c1"># These variables will be loaded from the .env file. However, if</span>
    <span class="c1"># there is a shell environment variable having the same name,</span>
    <span class="c1"># that will take precedence.</span>

    <span class="n">APP_CONFIG</span><span class="p">:</span> <span class="n">AppConfig</span> <span class="o">=</span> <span class="n">AppConfig</span><span class="p">()</span>

    <span class="c1"># define global variables with the Field class</span>
    <span class="n">ENV_STATE</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="n">env</span><span class="o">=</span><span class="s2">&quot;ENV_STATE&quot;</span><span class="p">)</span>

    <span class="c1"># environment specific variables do not need the Field class</span>
    <span class="n">REDIS_HOST</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">REDIS_PORT</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">REDIS_PASS</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">class</span> <span class="nc">Config</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Loads the dotenv file.&quot;&quot;&quot;</span>

        <span class="n">env_file</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;.env&quot;</span>


<span class="k">class</span> <span class="nc">DevConfig</span><span class="p">(</span><span class="n">GlobalConfig</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Development configurations.&quot;&quot;&quot;</span>

    <span class="k">class</span> <span class="nc">Config</span><span class="p">:</span>
        <span class="n">env_prefix</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;DEV_&quot;</span>


<span class="k">class</span> <span class="nc">ProdConfig</span><span class="p">(</span><span class="n">GlobalConfig</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Production configurations.&quot;&quot;&quot;</span>

    <span class="k">class</span> <span class="nc">Config</span><span class="p">:</span>
        <span class="n">env_prefix</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;PROD_&quot;</span>


<span class="k">class</span> <span class="nc">FactoryConfig</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Returns a config instance dependending on the ENV_STATE variable.&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">env_state</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">env_state</span> <span class="o">=</span> <span class="n">env_state</span>

    <span class="k">def</span> <span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">env_state</span> <span class="o">==</span> <span class="s2">&quot;dev&quot;</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">DevConfig</span><span class="p">()</span>

        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">env_state</span> <span class="o">==</span> <span class="s2">&quot;prod&quot;</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">ProdConfig</span><span class="p">()</span>


<span class="n">cnf</span> <span class="o">=</span> <span class="n">FactoryConfig</span><span class="p">(</span><span class="n">GlobalConfig</span><span class="p">()</span><span class="o">.</span><span class="n">ENV_STATE</span><span class="p">)()</span>
<span class="nb">print</span><span class="p">(</span><span class="n">cnf</span><span class="o">.</span><span class="fm">__repr__</span><span class="p">())</span>
</code></pre></div>

<p>The print statement of the last line in the above code block is to inspect the
<strong>active configuration</strong> class. You'll soon learn what I meant by the term
<strong>active configuration</strong>. You can comment out the last line while using the code in
production. Let's explain what's going on with each of the classes defined above.</p>
<h4>AppConfig</h4>
<p>The <code>AppConfig</code> class defines the config variables required for you API's internal
logic. In this case I'm not loading the variables from the <code>.env</code> file, rather defining
them directly in the class. You can also define and import them from another
<code>app_configs.py</code> file if necessary but they shouldn't be placed in the <code>.env</code> file. For
data validation to work, you've to inherit from Pydantic's <code>BaseModel</code> and annotate the
attributes using type hints while constructing the <code>AppConfig</code> class. Later, this class
is called from the <code>GlobalConfig</code> class to build a nested data structure.</p>
<h4>GlobalConfig</h4>
<p><code>GlobalConfig</code> defines the variables that propagates through other environment classes
and the attributes of this class are globally accessible from all other environments. In
this class, the variables are loaded from the <code>.env</code> file. In the <code>.env</code> file, global
variables don't have any environment specific prefixes like <code>DEV_</code> or <code>PROD_</code> before
them. The class <code>GlobalConfig</code> inherits from Pydantic's <code>BaseSettings</code> which helps to
load and read the variables from the <code>.env</code> file. The <code>.env</code> file itself is loaded in
the nested <code>Config</code> class. Although the environment variables are loaded from the <code>.env</code>
file, Pydantic also loads your actual shell environment variables at the same time. From
Pydantic's [documentation]:</p>
<blockquote>
<p>Even when using a dotenv file, Pydantic will still read environment variables as well
as the dotenv file, <strong>environment variables will always take priority over values
loaded from a dotenv file</strong>.</p>
</blockquote>
<p>This means you can keep the sensitive variables in your <code>.bashrc</code> or <code>zshrc</code> and
Pydantic will inject them during runtime. It's a powerful feature, as it implies that
you can easily keep the insensitive variables in your <code>.env</code> file and include that to
the version control system. Meanwhile the sensitive information should be injected as a
shell environment variable. For example, although I've defined an attribute called
<code>REDIS_PASS</code> in the <code>GlobalConfig</code> class, there is no mention of any <code>REDIS_PASS</code>
variable in the <code>.env</code> file. So normally, it returns <code>None</code> but you can easily inject a
<em>password</em> into the <code>REDIS_PASS</code> variable from the shell. Assuming that you've set up
your <code>venv</code> and installed the dependencies, you can test it by copying the contents of
the above code snippet in file called <code>configs.py</code> and running the commands below:</p>
<div class="highlight"><pre><span></span><code><span class="nb">export</span> <span class="nv">DEV_REDIS_PASS</span><span class="o">=</span>ubuntu
python configs.py
</code></pre></div>

<p>This should printout:</p>
<div class="highlight"><pre><span></span><code>&gt;&gt;&gt; DevConfig(
...     ENV_STATE=&#39;dev&#39;,
...     APP_CONFIG=AppConfig(VAR_A=33, VAR_B=22.0),
...     REDIS_PASS=&#39;ubuntu&#39;,
...     REDIS_HOST=&#39;127.0.0.1&#39;, REDIS_PORT=4000)
</code></pre></div>

<p>Notice how your injected <code>REDIS_PASS</code> has appeared in the printed config class instance.
Although I injected <code>DEV_REDIS_PASS</code> into the environment variable, it appeared as
<code>REDIS_PASS</code> inside the <code>DevConfig</code> instance. This is convenient because you won't need
to change the name of the variables in your codebase when you change the environment. To
understand why it printed an instance of the <code>DevConfig</code> class, refer to the
<a href="#factoryconfig">FactoryConfig</a> section.</p>
<h4>DevConfig</h4>
<p><code>DevConfig</code> class inherits from the <code>GlobalConfig</code> class and it can define additional
variables specific to the development environment. It inherits all the variables defined
in the <code>GlobalConfig</code> class. In this case, the <code>DevConfig</code> class doesn't define any new
variable.</p>
<p>The nested <code>Config</code> class inside <code>DevConfig</code> defines an attribute <code>env_prefix</code> and
assigns <code>DEV_</code> prefix to it. This helps Pydantic to read your prefixed variables like
<code>DEV_REDIS_HOST</code>, <code>DEV_REDIS_PORT</code> etc without you having to explicitly mention them.</p>
<h4>ProdConfig</h4>
<p><code>ProdConfig</code> class also inherits from the <code>GlobalConfig</code> class and it can define
additional variables specific to the production environment. It inherits all the
variables defined in the <code>GlobalConfig</code> class. In this case, like <code>DevConfig</code> this class
doesn't define any new variable.</p>
<p>The nested <code>Config</code> class inside <code>ProdConfig</code> defines an attribute <code>env_prefix</code> and
assigns <code>PROD_</code> prefix to it. This helps Pydantic to read your prefixed variables like
<code>PROD_REDIS_HOST</code>, <code>PROD_REDIS_PORT</code> etc without you having to explicitly mention them.</p>
<h4>FactoryConfig</h4>
<p><code>FactoryConfig</code> is the controller class that dictates which config class should be
activated based on the environment state defined as <code>ENV_STATE</code> in the <code>.env</code> file. If
it finds <code>ENV_STATE="dev"</code> then the control flow statements in the <code>FactoryConfig</code> class
will activate the development configs <em>(DevConfig)</em>. Similarly, if <code>ENV_STATE="prod"</code> is
found then the control flow will activate the production configs <em>(ProdConfig)</em>. Since
the current environment state is <code>ENV_STATE="dev"</code>, when you run the code, it prints an
instance of the activated <code>DevConfig</code> class. This way, you can assign different values
to the same variable based on different <em>environment contexts</em>.</p>
<p>You can also dynamically change the environment by changing the value of <code>ENV_STATE</code> on
your shell. Run:</p>
<div class="highlight"><pre><span></span><code>EXPORT <span class="nv">ENV_STATE</span><span class="o">=</span><span class="s2">&quot;prod&quot;</span>
python configs.py
</code></pre></div>

<p>This time the config instance should change and print the following:</p>
<div class="highlight"><pre><span></span><code>&gt;&gt;&gt; ProdConfig(
...     ENV_STATE=&#39;prod&#39;,
...     APP_CONFIG=AppConfig(VAR_A=33, VAR_B=22.0),
...     REDIS_PASS=&#39;ubuntu&#39;, REDIS_HOST=&#39;127.0.0.2&#39;,
...     REDIS_PORT=5000)
</code></pre></div>

<h2>Accessing the configs</h2>
<p>Using the config variables is easy. Suppose you want use the variables in file called
<code>app.py</code>. You can easily do so as shown in the following code block:</p>
<div class="highlight"><pre><span></span><code><span class="c1"># app.py</span>

<span class="kn">from</span> <span class="nn">configs</span> <span class="kn">import</span> <span class="n">cnf</span>


<span class="n">APP_CONFIG</span> <span class="o">=</span> <span class="n">cnf</span><span class="o">.</span><span class="n">APP_CONFIG</span>
<span class="n">VAR_A</span> <span class="o">=</span> <span class="n">APP_CONFIG</span><span class="o">.</span><span class="n">VAR_A</span>  <span class="c1"># this is a nested config</span>
<span class="n">VAR_B</span> <span class="o">=</span> <span class="n">APP_CONFIG</span><span class="o">.</span><span class="n">VAR_B</span>
<span class="n">REDIS_HOST</span> <span class="o">=</span> <span class="n">cnf</span><span class="o">.</span><span class="n">REDIS_HOST</span>  <span class="c1"># this is a top-level config</span>
<span class="n">REDIS_PORT</span> <span class="o">=</span> <span class="n">cnf</span><span class="o">.</span><span class="n">REDIS_PORT</span>


<span class="nb">print</span><span class="p">(</span><span class="n">APP_CONFIG</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">VAR_A</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">VAR_B</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">REDIS_HOST</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">REDIS_PORT</span><span class="p">)</span>
</code></pre></div>

<p>This should print out:</p>
<div class="highlight"><pre><span></span><code>&gt;&gt;&gt; ProdConfig(
...     ENV_STATE=&#39;prod&#39;,
...     APP_CONFIG=AppConfig(VAR_A=33, VAR_B=22.0),
...     REDIS_PASS=&#39;ubuntu&#39;,
...     REDIS_HOST=&#39;127.0.0.2&#39;,
...     REDIS_PORT=5000)

VAR_A=33 VAR_B=22.0
33
22.0
127.0.0.2
5000
</code></pre></div>

<h2>Extending the pipeline</h2>
<p>The modular design demonstrated above is easy to maintain and extend in my opinion. Previously,
for simplicity, I've defined only two environment scopes; development and production. Let's say
you want to add the configs for your <em>staging environment</em>.</p>
<ul>
<li>First you'll need to add those <em>staging</em> variables to the <code>.env</code> file.</li>
</ul>
<div class="highlight"><pre><span></span><code>...

STAGE_REDIS_HOST=&quot;127.0.0.3&quot;
STAGE_REDIS_PORT=&quot;6000&quot;

...
</code></pre></div>

<ul>
<li>Then you've to create a class named <code>StageConfig</code> that inherits from the
<code>GlobalConfig</code> class. The architecture of the class is  similar to that of the
<code>DevConfig</code> or <code>ProdConfig</code> class.</li>
</ul>
<div class="highlight"><pre><span></span><code><span class="c1"># configs.py</span>
<span class="o">...</span>


<span class="k">class</span> <span class="nc">StageConfig</span><span class="p">(</span><span class="n">GlobalConfig</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Staging configurations.&quot;&quot;&quot;</span>

    <span class="k">class</span> <span class="nc">Config</span><span class="p">:</span>
        <span class="n">env_prefix</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;STAGE_&quot;</span>


<span class="o">...</span>
</code></pre></div>

<ul>
<li>Finally, you'll need to insert an <code>ENV_STATE</code> logic into the control flow of the
<code>FactoryConfig</code> class. See how I've appended another if-else block to the previous
(prod) block.</li>
</ul>
<div class="highlight"><pre><span></span><code><span class="c1"># configs.py</span>
<span class="o">...</span>

<span class="k">class</span> <span class="nc">FactoryConfig</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Returns a config instance depending on the ENV_STATE variable.&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">env_state</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">env_state</span> <span class="o">=</span> <span class="n">env_state</span>

    <span class="k">def</span> <span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">env_state</span> <span class="o">==</span> <span class="s2">&quot;dev&quot;</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">DevConfig</span><span class="p">()</span>

        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">env_state</span> <span class="o">==</span> <span class="s2">&quot;prod&quot;</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">ProdConfig</span><span class="p">()</span>

        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">env_state</span> <span class="o">==</span> <span class="s2">&quot;stage&quot;</span>
            <span class="k">return</span> <span class="n">StageConfig</span><span class="p">()</span>
<span class="o">...</span>
</code></pre></div>

<p>To see your new addition in action just change the <code>ENV_STATE</code> to "stage" in the <code>.env</code>
file or export it to your shell environment.</p>
<div class="highlight"><pre><span></span><code><span class="k">export</span><span class="w"> </span><span class="n">ENV_STATE</span><span class="o">=</span><span class="s2">&quot;stage&quot;</span><span class="w"></span>
<span class="n">python</span><span class="w"> </span><span class="n">configs</span><span class="o">.</span><span class="n">py</span><span class="w"></span>
</code></pre></div>

<p>This will print out an instance of the class <code>StageConfig</code>.</p>
<h2>Remarks</h2>
<p>The above workflow works perfectly for my usage scenario. So subjectively, I feel like
it's an elegant solution to a very icky problem. Your mileage will definitely vary.</p>
<h2>Resources</h2>
<ul>
<li><a href="https://pydantic-docs.helpmanual.io/usage/settings/">Settings management with Pydantic</a></li>
<li><a href="https://flask.palletsprojects.com/en/1.1.x/config/">Flask config management</a></li>
</ul>


             
 
            
            
            







            <hr/>
        </div>
        <section id="article-sidebar" class="span2">
            <h4>Published</h4>
            <time itemprop="dateCreated" datetime="2020-07-13T00:00:00+06:00">Mon 13 July 2020</time>
            <h4>Category</h4>
            <a class="category-link" href="./categories.html#python-ref">python</a>
            <h4>Tags</h4>
            <ul class="list-of-tags tags-in-article">
                <li><a href="./tags.html#python-ref">Python
                    <span class="superscript">58</span>
</a></li>
            </ul>
<h4>Contact</h4>
<div id="sidebar-social-link">
    <a href="mailto:redowan.nafi@gmail.com" title="" target="_blank" rel="nofollow noopener noreferrer">
        <svg xmlns="http://www.w3.org/2000/svg" aria-label="Mail" role="img" viewBox="0 0 512 512"><rect width="512" height="512" rx="15%" fill="#328cff"/><path d="m250 186c-46 0-69 35-69 74 0 44 29 72 68 72 43 0 73-32 73-75 0-44-34-71-72-71zm-1-37c30 0 57 13 77 33 0-22 35-22 35 1v150c-1 10 10 16 16 9 25-25 54-128-14-187-64-56-149-47-195-15-48 33-79 107-49 175 33 76 126 99 182 76 28-12 41 26 12 39-45 19-168 17-225-82-38-68-36-185 67-248 78-46 182-33 244 32 66 69 62 197-2 246-28 23-71 1-71-32v-11c-20 20-47 32-77 32-57 0-108-51-108-108 0-58 51-110 108-110" fill="#fff"/></svg>
    </a>
    <a href="https://github.com/rednafi" title="" target="_blank" rel="nofollow noopener noreferrer">
        <svg xmlns="http://www.w3.org/2000/svg" aria-label="GitHub" role="img" viewBox="0 0 512 512"><rect width="512" height="512" rx="15%" fill="#1B1817"/><path fill="#fff" d="M335 499c14 0 12 17 12 17H165s-2-17 12-17c13 0 16-6 16-12l-1-50c-71 16-86-28-86-28-12-30-28-37-28-37-24-16 1-16 1-16 26 2 40 26 40 26 22 39 59 28 74 22 2-17 9-28 16-35-57-6-116-28-116-126 0-28 10-51 26-69-3-6-11-32 3-67 0 0 21-7 70 26 42-12 86-12 128 0 49-33 70-26 70-26 14 35 6 61 3 67 16 18 26 41 26 69 0 98-60 120-117 126 10 8 18 24 18 48l-1 70c0 6 3 12 16 12z"/></svg>
    </a>
    <a href="https://twitter.com/rednafi" title="" target="_blank" rel="nofollow noopener noreferrer">
        <svg xmlns="http://www.w3.org/2000/svg" aria-label="Twitter" role="img" viewBox="0 0 512 512"><rect width="512" height="512" rx="15%" fill="#1da1f3"/><path fill="#fff" d="M437 152a72 72 0 0 1-40 12 72 72 0 0 0 32-40 72 72 0 0 1-45 17 72 72 0 0 0-122 65 200 200 0 0 1-145-74 72 72 0 0 0 22 94 72 72 0 0 1-32-7 72 72 0 0 0 56 69 72 72 0 0 1-32 1 72 72 0 0 0 67 50 200 200 0 0 1-105 29 200 200 0 0 0 309-179 200 200 0 0 0 35-37"/></svg>
    </a>
    <a href="https://www.goodreads.com/user/show/53485837-redowan-delowar" title="" target="_blank" rel="nofollow noopener noreferrer">
        <svg height="512" viewBox="0 0 512 512" width="512" xmlns="http://www.w3.org/2000/svg"><rect fill="#EAE6CF" height="512" rx="64" width="512"/><path d="m254.92444 336.92444c43.2889-.36 74.07112-22.01333 92.33334-64.95111h.95556v65.48889c0 4.88-.32 12.44889-.95556 22.73333-1.30222 10.64445-4.78222 22.10223-10.42666 34.36889-5.65778 11.54667-14.79112 21.38667-27.37778 29.49778-12.44889 8.84-29.81778 13.44-52.12001 13.80444-21.48444 0-39.65333-5.59555-54.52444-16.77777-15.2-11.00889-24.08001-28.87111-26.65778-53.58667h-18.89778c1.93778 32.11111 12.18667 55.02667 30.76444 68.74222 18.08889 13.16445 41.04001 19.75556 68.83556 19.75556 27.45778 0 48.87112-5.14223 64.21778-15.43111 15.18223-9.92 26.08445-22.28445 32.71556-37.08 6.62222-14.79111 10.58222-28.86667 11.86667-42.21334.98222-13.35555 1.45778-22.91555 1.45778-28.68889v-270.088875h-18.90667v59.537775h-.95556c-7.27555-21.82667-19.30666-38.333335-36.12-49.524445-16.96-11.00445-35.70222-16.51111-56.21333-16.51111-35.72001.72444-62.85779 14.52444-81.43112 41.40889-19.07111 26.697775-28.59556 59.631105-28.59556 98.782195 0 40.23557 9.04445 73.52001 27.13334 99.86224 18.27555 26.88889 45.89778 40.51111 82.90222 40.87111zm-68.34222-224.89777c14.85333-24.359995 37.63111-36.986665 68.34222-37.888885 31.50223.90666 54.83556 13.17333 70.03556 36.808885 15.18223 23.64 22.77778 52.05331 22.77778 85.25331s-7.59555 61.43112-22.77778 84.70668c-15.2 24.72444-38.53333 37.34667-70.03556 37.88889-29.72889-.54667-52.36-12.81778-67.86222-36.80889-15.67556-23.27556-23.50667-51.87112-23.50667-85.79112-.004-31.75556 7.67111-59.81332 23.02667-84.16887z" fill="#743901"/></svg>
    </a>
    <a href="/reflections/feeds/all.atom.xml" title="" target="_blank" rel="nofollow noopener noreferrer">
        <svg xmlns="http://www.w3.org/2000/svg" aria-label="RSS" role="img" viewBox="0 0 512 512"><rect width="512" height="512" rx="15%" fill="#f80"/><circle cx="145" cy="367" r="35" fill="#fff"/><path fill="none" stroke="#fff" stroke-width="60" d="M109 241c89 0 162 73 162 162M109 127c152 0 276 124 276 276"/></svg>
    </a>
</div>
            





            





        </section>
</div>
</article>
<!-- Root element of PhotoSwipe. Must have class pswp. -->
<div class="pswp" tabindex="-1" role="dialog" aria-hidden="true">

    <!-- Background of PhotoSwipe.
         It's a separate element as animating opacity is faster than rgba(). -->
    <div class="pswp__bg"></div>

    <!-- Slides wrapper with overflow:hidden. -->
    <div class="pswp__scroll-wrap">

        <!-- Container that holds slides.
            PhotoSwipe keeps only 3 of them in the DOM to save memory.
            Don't modify these 3 pswp__item elements, data is added later on. -->
        <div class="pswp__container">
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
        </div>

        <!-- Default (PhotoSwipeUI_Default) interface on top of sliding area. Can be changed. -->
        <div class="pswp__ui pswp__ui--hidden">

            <div class="pswp__top-bar">

                <!--  Controls are self-explanatory. Order can be changed. -->

                <div class="pswp__counter"></div>

                <button class="pswp__button pswp__button--close" title="Close (Esc)"></button>

                <button class="pswp__button pswp__button--share" title="Share"></button>

                <button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>

                <button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button>

                <!-- Preloader demo https://codepen.io/dimsemenov/pen/yyBWoR -->
                <!-- element will get class pswp__preloader--active when preloader is running -->
                <div class="pswp__preloader">
                    <div class="pswp__preloader__icn">
                      <div class="pswp__preloader__cut">
                        <div class="pswp__preloader__donut"></div>
                      </div>
                    </div>
                </div>
            </div>

            <div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap">
                <div class="pswp__share-tooltip"></div>
            </div>

            <button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
            </button>

            <button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)">
            </button>

            <div class="pswp__caption">
                <div class="pswp__caption__center"></div>
            </div>

        </div>

    </div>

</div>                    </div>
                    <div class="span1"></div>
                </div>
            </div>
        </div>
<footer>



    <div id="fpowered">

            © 2020-2022 • Redowan Delowar • All Rights Reserved


    </div>
</footer>            <script src="//code.jquery.com/jquery.min.js"></script>
        <script src="//netdna.bootstrapcdn.com/twitter-bootstrap/2.3.2/js/bootstrap.min.js"></script>
        <script src="./theme/js/elegant.prod.9e9d5ce754.js"></script>
        <script>
            function validateForm(query)
            {
                return (query.length > 0);
            }
        </script>

    <script>
    (function () {
        if (window.location.hash.match(/^#comment-\d+$/)) {
            $('#comment_thread').collapse('show');
        }
    })();
    window.onhashchange=function(){
        if (window.location.hash.match(/^#comment-\d+$/))
            window.location.reload(true);
    }
    $('#comment_thread').on('shown', function () {
        var link = document.getElementById('comment-accordion-toggle');
        var old_innerHTML = link.innerHTML;
        $(link).fadeOut(200, function() {
            $(this).text('Click here to hide comments').fadeIn(200);
        });
        $('#comment_thread').on('hidden', function () {
            $(link).fadeOut(200, function() {
                $(this).text(old_innerHTML).fadeIn(200);
            });
        })
    })
</script>

    </body>
    <!-- Theme: Elegant built for Pelican
        License : MIT -->
</html>