<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <link rel="stylesheet" type="text/css" href="./theme/css/elegant.prod.9e9d5ce754.css" media="screen">
        <link rel="stylesheet" type="text/css" href="./theme/css/custom.css" media="screen">

        <link rel="dns-prefetch" href="//fonts.googleapis.com">
        <link rel="preconnect" href="https://fonts.gstatic.com/" crossorigin>

        <meta name="google-site-verification" content="<meta name='google-site-verification' content='N5QEPRj-LpgoEY0Hf3uVMmZq8kjDwTFjd54IgvLmRBc' />" />        <meta name="author" content="Redowan Delowar" />

        <meta name="description" content="In Python, even though I adore writing tests in a functional manner via Pytest, I still have a soft corner for the tools provided in the unittest.mock module. I like the fact it&#39;s baked into the standard library and is quite flexible. Moreover, I&#39;m yet to see another mock …
" />
        <meta property="og:type" content="article" />
        <meta name="twitter:card" content="summary">

<meta name="keywords" content="Python, Testing, python, " />

<meta property="og:title" content="Patching test dependencies via Pytest fixture &amp; unittest mock "/>
<meta property="og:url" content="./patching-test-dependencies-via-pytest-fixture-unittest-mock.html" />
<meta property="og:description" content="In Python, even though I adore writing tests in a functional manner via Pytest, I still have a soft corner for the tools provided in the unittest.mock module. I like the fact it&#39;s baked into the standard library and is quite flexible. Moreover, I&#39;m yet to see another mock …" />
<meta property="og:site_name" content="Redowan&#39;s Reflections" />
<meta property="og:article:author" content="Redowan Delowar" />
<meta property="og:article:published_time" content="2022-02-27T00:00:00+06:00" />
<meta name="twitter:title" content="Patching test dependencies via Pytest fixture &amp; unittest mock ">
<meta name="twitter:description" content="In Python, even though I adore writing tests in a functional manner via Pytest, I still have a soft corner for the tools provided in the unittest.mock module. I like the fact it&#39;s baked into the standard library and is quite flexible. Moreover, I&#39;m yet to see another mock …">
<meta property="og:image" content="https://user-images.githubusercontent.com/30027932/149235389-c6b85b40-5515-4de4-a922-7b0f91efd0cf.png" />
<meta name="twitter:image" content="https://user-images.githubusercontent.com/30027932/149235389-c6b85b40-5515-4de4-a922-7b0f91efd0cf.png" >

        <title>Patching test dependencies via Pytest fixture &amp; unittest mock  · Redowan&#39;s Reflections
</title>
        <link href="https://rednafi.github.io/reflections/feeds/all.atom.xml" type="application/atom+xml" rel="alternate" title="Redowan&#39;s Reflections - Full Atom Feed" />

<script>
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
     (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
     m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
     })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
    ga('create', 'UA-217287505-1', 'auto');
    ga('send', 'pageview');
</script>


    </head>
    <body>
        <div id="content">
            <div class="navbar navbar-static-top">
                <div class="navbar-inner">
                    <div class="container-fluid">
                        <a class="btn btn-navbar" data-toggle="collapse" data-target=".nav-collapse">
                            <span class="icon-bar"></span>
                            <span class="icon-bar"></span>
                            <span class="icon-bar"></span>
                        </a>
                        <a class="brand" href="./"><span class=site-name>Redowan's Reflections</span></a>
                        <div class="nav-collapse collapse">
                            <ul class="nav pull-right top-menu">
                                <li >
                                    <a href=
                                       .
                                    >Home</a>
                                </li>
                                <li ><a href="./pages/contact.html">Contact</a></li>
                                <li ><a href="./categories.html">Categories</a></li>
                                <li ><a href="./tags.html">Tags</a></li>
                                <li ><a href="./archives.html">Archives</a></li>
                                <li>
                                  <form action="https://www.google.com/search" class="navbar-search" method="get" name="searchform" target="_blank">
                                    <input name="sitesearch" type="hidden"
                                    value="rednafi.github.io/reflections">
                                    <input autocomplete="on" class="search-query" name="q" placeholder="Search"
                                    required="required"  type="text">
                                    <input type="submit" value="Search" style="visibility: hidden;" /></form>
                                  </form>
                                </li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
            <div class="container-fluid">
                <div class="row-fluid">
                    <div class="span1"></div>
                    <div class="span10">
<article itemscope>
<div class="row-fluid">
    <header class="page-header span10 offset2">
        <h1>
            <a href="./patching-test-dependencies-via-pytest-fixture-unittest-mock.html">
                Patching test dependencies via Pytest fixture & unittest mock
            </a>
        </h1>
    </header>
</div>

<div class="row-fluid">
        <div class="span8 offset2 article-content">
            
            <p>In Python, even though I adore writing tests in a functional manner via Pytest, I still
have a soft corner for the tools provided in the <code>unittest.mock</code> module. I like the fact
it's baked into the standard library and is quite flexible. Moreover, I'm yet to see
another <code>mock</code> library in any other language or in the Python ecosystem that allows you
to mock your targets in such a terse, flexible, and maintainable fashion.</p>
<p>So, in almost all the tests that I write for both my OSS projects and at my workplace, I
use <code>unittest.mock.patch</code> exclusively for performing mock-patch. Consider this example:</p>
<div class="highlight"><pre><span></span><code><span class="c1"># src.py</span>
<span class="kn">from</span> <span class="nn">__future__</span> <span class="kn">import</span> <span class="n">annotations</span>

<span class="kn">import</span> <span class="nn">random</span>

<span class="c1"># In &lt;Python3.9, import this from the &#39;typing&#39; module.</span>
<span class="kn">from</span> <span class="nn">collections.abc</span> <span class="kn">import</span> <span class="n">Sequence</span>


<span class="k">def</span> <span class="nf">prepend_random</span><span class="p">(</span><span class="n">choices</span><span class="p">:</span> <span class="n">Sequence</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span> <span class="n">target</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Prepend a random prefix from the choices squence to</span>
<span class="sd">    the target string.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="n">choices</span><span class="p">)</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">target</span><span class="si">}</span><span class="s2">&quot;</span>


<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">prepend_random</span><span class="p">([</span><span class="s2">&quot;hello&quot;</span><span class="p">,</span> <span class="s2">&quot;world&quot;</span><span class="p">,</span> <span class="s2">&quot;mars&quot;</span><span class="p">],</span> <span class="n">target</span><span class="o">=</span><span class="s2">&quot;greet&quot;</span><span class="p">))</span>
</code></pre></div>

<p>Here, the <code>prepend_random</code> function prepends a random prefix from the <code>choices</code> sequence
to a <code>target</code> string. To accomplish this randomness, I used the <code>random.choice</code> function
from the standard library. Now, the question is, how'd you test this. The function
<code>prepend_random</code> has one global dependency; it's the <code>random.choice</code> function and you'll
need to mock it out. Otherwise, you won't be able to test the enclosing <code>prepend_random</code>
function in a determinstic way. Here's how you might test it with Pytest:</p>
<div class="highlight"><pre><span></span><code><span class="c1"># src.py</span>
<span class="o">...</span>
<span class="kn">from</span> <span class="nn">unittest.mock</span> <span class="kn">import</span> <span class="n">patch</span>


<span class="nd">@patch</span><span class="p">(</span><span class="s2">&quot;src.random.choice&quot;</span><span class="p">,</span> <span class="n">return_value</span><span class="o">=</span><span class="s2">&quot;test_choice&quot;</span><span class="p">,</span> <span class="n">autospec</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">test_prepend_random</span><span class="p">(</span><span class="n">mock_random_choice</span><span class="p">):</span>
    <span class="n">choices</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;some&quot;</span><span class="p">,</span> <span class="s2">&quot;choice&quot;</span><span class="p">)</span>
    <span class="n">target</span> <span class="o">=</span> <span class="s2">&quot;test_target&quot;</span>
    <span class="n">expected_value</span> <span class="o">=</span> <span class="s2">&quot;test_choice_test_target&quot;</span>

    <span class="k">assert</span> <span class="n">prepend_random</span><span class="p">(</span><span class="n">choices</span><span class="p">,</span> <span class="n">target</span><span class="p">)</span> <span class="o">==</span> <span class="n">expected_value</span>

    <span class="n">mock_random_choice</span><span class="o">.</span><span class="n">assert_called_once_with</span><span class="p">(</span><span class="n">choices</span><span class="p">)</span>


<span class="o">...</span>
</code></pre></div>

<p>If you run <code>pytest -v -s src.py</code>, the test will pass. The <code>unittest.mock.patch</code> function
is used here to mock the <code>random.choice</code> function and guarantee that it returns a
controlled value instead of a random one. Shaving off this randomness of the <code>random.
choice</code> function helps us test the behaviors of the <code>prepend_random</code> function in a more
reproducible fashion. The <code>autospec=True</code> makes sure that the behavior of the mocked
object—in this case, the function signature—is the same as the original object.</p>
<p>Another thing is, you can also use the <code>patch</code> function as a context manager like this:</p>
<div class="highlight"><pre><span></span><code><span class="c1"># src.py</span>
<span class="o">...</span>


<span class="k">def</span> <span class="nf">test_prepend_random</span><span class="p">():</span>
    <span class="n">choices</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;some&quot;</span><span class="p">,</span> <span class="s2">&quot;choice&quot;</span><span class="p">)</span>
    <span class="n">target</span> <span class="o">=</span> <span class="s2">&quot;test_target&quot;</span>
    <span class="n">expected_value</span> <span class="o">=</span> <span class="s2">&quot;test_choice_test_target&quot;</span>

    <span class="k">with</span> <span class="n">patch</span><span class="p">(</span>
        <span class="s2">&quot;src.random.choice&quot;</span><span class="p">,</span> <span class="n">return_value</span><span class="o">=</span><span class="s2">&quot;test_choice&quot;</span><span class="p">,</span> <span class="n">autospec</span><span class="o">=</span><span class="kc">True</span>
    <span class="p">)</span> <span class="k">as</span> <span class="n">mock_random_choice</span><span class="p">:</span>
        <span class="k">assert</span> <span class="n">prepend_random</span><span class="p">(</span><span class="n">choices</span><span class="p">,</span> <span class="n">target</span><span class="p">)</span> <span class="o">==</span> <span class="n">expected_value</span>

        <span class="n">mock_random_choice</span><span class="o">.</span><span class="n">assert_called_once_with</span><span class="p">(</span><span class="n">choices</span><span class="p">)</span>


<span class="o">...</span>
</code></pre></div>

<p>While this works, the situation quickly spirals out of control whenever you need to test
out multiple behaviors of a function and you want to achieve loose coupling between the
tests by disentangling the behaviors in separate test functions. In that case, you'll
need to mock out the dependencies in each test function.</p>
<p>The situation worsens when each of your target functions has multiple dependencies. To
be specific, if your target function has <code>m</code> behaviors and <code>n</code> dependencies that need to
be mocked out, then the number of the <code>patch</code> decorators that practically do the same
thing will be <code>m x n</code>. Just for a single function, it'll create a monstrosity similar to
this:</p>
<div class="highlight"><pre><span></span><code><span class="c1"># src.py</span>
<span class="kn">from</span> <span class="nn">unittest.mock</span> <span class="kn">import</span> <span class="n">patch</span>

<span class="o">...</span>


<span class="k">def</span> <span class="nf">func</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Target function that&#39;ll be tested.&quot;&quot;&quot;</span>

    <span class="n">dep_1</span><span class="p">()</span>
    <span class="n">dep_2</span><span class="p">()</span>
    <span class="k">return</span> <span class="mi">42</span>


<span class="nd">@patch</span><span class="p">(</span><span class="s2">&quot;src.dep_1&quot;</span><span class="p">,</span> <span class="n">autospec</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="nd">@patch</span><span class="p">(</span><span class="s2">&quot;src.dep_2&quot;</span><span class="p">,</span> <span class="n">autospec</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">test_func_error</span><span class="p">(</span><span class="n">mock_dep_1</span><span class="p">,</span> <span class="n">mock_dep_2</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Behavior one.&quot;&quot;&quot;</span>
    <span class="o">...</span>


<span class="nd">@patch</span><span class="p">(</span><span class="s2">&quot;src.dep_1&quot;</span><span class="p">,</span> <span class="n">autospec</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="nd">@patch</span><span class="p">(</span><span class="s2">&quot;src.dep_2&quot;</span><span class="p">,</span> <span class="n">autospec</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">test_func_ok</span><span class="p">(</span><span class="n">mock_dep_1</span><span class="p">,</span> <span class="n">mock_dep_2</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Behavior two.&quot;&quot;&quot;</span>
    <span class="o">...</span>
</code></pre></div>

<p>Now imagine the situation for multiple target functions with multiple behaviors where
testing each behavior requires multiple dependencies. The DRY gods will be furious!</p>
<p>The situation can be improved by wrapping the tests in a <code>unittest</code> style class and
mocking out the common dependencies in the class scope as follows:</p>
<div class="highlight"><pre><span></span><code><span class="c1"># src.py</span>
<span class="kn">from</span> <span class="nn">unittest.mock</span> <span class="kn">import</span> <span class="n">patch</span>

<span class="o">...</span>


<span class="nd">@patch</span><span class="p">(</span><span class="s2">&quot;src.dep_1&quot;</span><span class="p">,</span> <span class="n">return_value</span><span class="o">=</span><span class="mi">42</span><span class="p">,</span> <span class="n">autospec</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="nd">@patch</span><span class="p">(</span><span class="s2">&quot;src.dep_2&quot;</span><span class="p">,</span> <span class="n">return_value</span><span class="o">=</span><span class="mi">42</span><span class="p">,</span> <span class="n">autospec</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">class</span> <span class="nc">TestFunc</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">test_func_error</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="o">...</span>

    <span class="k">def</span> <span class="nf">test_func_ok</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="o">...</span>
</code></pre></div>

<p>The above solution forces us to write <code>unittest</code> style OOP-driven tests and I'd like to
avoid that in my test suite. Also, this approach will mock all the dependencies in the
class scope and you can't opt-out of mocked dependencies if some of your tests don't
need that. We can do better. Let's rewrite a slightly modified version of the above case
with <code>pytest.fixture</code>. Here's how to do it:</p>
<div class="highlight"><pre><span></span><code><span class="c1"># src.py</span>
<span class="kn">from</span> <span class="nn">__future__</span> <span class="kn">import</span> <span class="n">annotations</span>

<span class="kn">import</span> <span class="nn">pytest</span>


<span class="k">def</span> <span class="nf">dep_1</span><span class="p">():</span>
    <span class="k">pass</span>


<span class="k">def</span> <span class="nf">dep_2</span><span class="p">():</span>
    <span class="k">pass</span>


<span class="k">def</span> <span class="nf">func</span><span class="p">(</span><span class="n">error</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Target function that we&#39;re going to test.&quot;&quot;&quot;</span>

    <span class="n">dep_1</span><span class="p">()</span>
    <span class="n">dep_2</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">error</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;Dummy type error.&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="mi">42</span>


<span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span>
<span class="k">def</span> <span class="nf">mock_dep_1</span><span class="p">():</span>
    <span class="k">with</span> <span class="n">patch</span><span class="p">(</span><span class="s2">&quot;src.dep_1&quot;</span><span class="p">,</span> <span class="n">return_value</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">autospec</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span> <span class="k">as</span> <span class="n">m</span><span class="p">:</span>
        <span class="k">yield</span> <span class="n">m</span>


<span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span>
<span class="k">def</span> <span class="nf">mock_dep_2</span><span class="p">():</span>
    <span class="k">with</span> <span class="n">patch</span><span class="p">(</span><span class="s2">&quot;src.dep_2&quot;</span><span class="p">,</span> <span class="n">return_value</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">autospec</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span> <span class="k">as</span> <span class="n">m</span><span class="p">:</span>
        <span class="k">yield</span> <span class="n">m</span>


<span class="k">def</span> <span class="nf">test_func_error</span><span class="p">(</span><span class="n">mock_dep_1</span><span class="p">,</span> <span class="n">mock_dep_2</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Test one behavior.&quot;&quot;&quot;</span>

    <span class="k">with</span> <span class="n">pytest</span><span class="o">.</span><span class="n">raises</span><span class="p">(</span><span class="ne">TypeError</span><span class="p">,</span> <span class="n">match</span><span class="o">=</span><span class="s2">&quot;Dummy type error.&quot;</span><span class="p">):</span>
        <span class="n">func</span><span class="p">(</span><span class="n">error</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">mock_dep_1</span><span class="o">.</span><span class="n">assert_called_once</span><span class="p">()</span>
    <span class="n">mock_dep_2</span><span class="o">.</span><span class="n">assert_called_once</span><span class="p">()</span>


<span class="k">def</span> <span class="nf">test_func_ok</span><span class="p">(</span><span class="n">mock_dep_1</span><span class="p">,</span> <span class="n">mock_dep_2</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Test another behavior.&quot;&quot;&quot;</span>

    <span class="k">assert</span> <span class="n">func</span><span class="p">()</span> <span class="o">==</span> <span class="mi">42</span>
    <span class="n">mock_dep_1</span><span class="o">.</span><span class="n">assert_called_once</span><span class="p">()</span>
    <span class="n">mock_dep_2</span><span class="o">.</span><span class="n">assert_called_once</span><span class="p">()</span>
</code></pre></div>

<p>The target function <code>func</code> has two dependencies that need to be mocked-up—<code>dep_1</code> and
<code>dep_2</code>. I mocked out the dependencies using the <code>unittest.mock.patch</code> interjector as
context managers while wrapping them in separate functions decorated with the
<code>@pytest.fixture</code> decorator.</p>
<p>Pay attention to the <code>yield</code> statement in the fixture functions. Pytest also allows you
to use <code>return</code> statement in fixtures. However, in this case, making the fixture
functions return generator objects was necessary. This way, the fixture function makes
sure that the teardown logic in the <code>with patch()...</code> block gets executed. Had you used
<code>return</code> here, the logic in the <code>__exit__</code> block of the <code>patch</code> context manager wouldn't
have the chance to be executed. If you replace the <code>yield</code> statement with <code>return</code> and
try to run the above snippet, Pytest will throw an error.</p>
<p>You can also write your custom teardown logic after the <code>yield</code> statement and Pytest
will execute the logic each time the fixture gets executed. It's similar to how teardown
works in <code>unittest</code> but in a functional and decoupled manner.</p>
<p>This approach has the following advantages:</p>
<ul>
<li>It appeases the DRY gods.</li>
<li>You won't have to wrap your tests in a class to avoid patching the same objects
multiple times.</li>
<li>This makes the <em>mocked dependency</em> usage more composable. In a test, you can pick and
choose which dependencies you need in their mocked form and which dependencies you don't
want to be mocked. If you don't want a particular dependency to be mocked in a test,
then don't pass the corresponding fixture as an argument of the test function.</li>
<li>If some of your mocked dependencies don't vary much during their test lifetime, you
can change the <code>scope</code> of the fixture to speed up the overall execution. By default,
fixtures run in <code>function</code> scope; that means, the fixture (mocking) will be executed
once per test function. This behavior can be changed via using the <code>scope</code> parameter of
the <code>@pytest.fixture(scope=...)</code> decorator. Other allowed scopes are <code>module</code> and
<code>session</code>. <strong>Module</strong> scope means, the fixture will be executed once per test module and
<strong>session</strong> scope means, the fixture will run once per Pytest session.</li>
</ul>
<h2>Another practical example</h2>
<p>The following snippet defines the <code>get</code> and <code>post</code> functions that make <code>GET</code> and <code>POST</code>
requests to a URL respectively. I used the canonical
<a href="https://www.python-httpx.org/">httpx</a> library to make the requests. Here, the functions
make external network calls to the <code>https://httpbin.org</code> URL:</p>
<div class="highlight"><pre><span></span><code><span class="c1"># src.py</span>
<span class="kn">from</span> <span class="nn">__future__</span> <span class="kn">import</span> <span class="n">annotations</span>

<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Any</span>

<span class="c1"># You&#39;ll have to pip install this.</span>
<span class="kn">import</span> <span class="nn">httpx</span>

<span class="n">client</span> <span class="o">=</span> <span class="n">httpx</span><span class="o">.</span><span class="n">Client</span><span class="p">(</span><span class="n">headers</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;Content-Type&quot;</span><span class="p">:</span> <span class="s2">&quot;application/json&quot;</span><span class="p">})</span>


<span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="n">url</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">httpx</span><span class="o">.</span><span class="n">Response</span><span class="p">:</span>
    <span class="k">return</span> <span class="n">client</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">post</span><span class="p">(</span><span class="n">url</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">data</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">httpx</span><span class="o">.</span><span class="n">Response</span><span class="p">:</span>
    <span class="k">return</span> <span class="n">client</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">json</span><span class="o">=</span><span class="n">data</span><span class="p">)</span>


<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>
    <span class="n">r_get</span> <span class="o">=</span> <span class="n">get</span><span class="p">(</span><span class="s2">&quot;https://httpbin.org/get&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">r_get</span><span class="o">.</span><span class="n">status_code</span><span class="p">)</span>

    <span class="n">r_post</span> <span class="o">=</span> <span class="n">post</span><span class="p">(</span><span class="s2">&quot;https://httpbin.org/post&quot;</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;hello&quot;</span><span class="p">:</span> <span class="s2">&quot;world&quot;</span><span class="p">})</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">r_post</span><span class="o">.</span><span class="n">status_code</span><span class="p">)</span>
</code></pre></div>

<p>Running the snippet will print the functions' respective HTTP response codes. If you
look closely, you'll notice that I'm instantiating the <code>client</code> object in the global
scope. This is because, both the <code>GET</code> and <code>POST</code> API calls share the same header. Let's
see how you can test these two functions:</p>
<div class="highlight"><pre><span></span><code><span class="c1"># test_src.py</span>
<span class="kn">from</span> <span class="nn">http</span> <span class="kn">import</span> <span class="n">HTTPStatus</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Any</span>
<span class="kn">from</span> <span class="nn">unittest.mock</span> <span class="kn">import</span> <span class="n">patch</span>

<span class="kn">import</span> <span class="nn">httpx</span>
<span class="kn">import</span> <span class="nn">pytest</span>

<span class="kn">import</span> <span class="nn">src</span>


<span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span><span class="p">(</span><span class="n">scope</span><span class="o">=</span><span class="s2">&quot;module&quot;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">mock_get</span><span class="p">():</span>
    <span class="k">with</span> <span class="n">patch</span><span class="o">.</span><span class="n">object</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="s2">&quot;client&quot;</span><span class="p">,</span> <span class="n">autospec</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span> <span class="k">as</span> <span class="n">m</span><span class="p">:</span>
        <span class="n">m</span><span class="o">.</span><span class="n">get</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="n">httpx</span><span class="o">.</span><span class="n">Response</span><span class="p">(</span>
            <span class="n">status_code</span><span class="o">=</span><span class="mi">200</span><span class="p">,</span>
            <span class="n">json</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;a&quot;</span><span class="p">:</span> <span class="s2">&quot;b&quot;</span><span class="p">},</span>
        <span class="p">)</span>
        <span class="k">yield</span> <span class="n">m</span>


<span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span><span class="p">(</span><span class="n">scope</span><span class="o">=</span><span class="s2">&quot;module&quot;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">mock_post</span><span class="p">():</span>
    <span class="k">with</span> <span class="n">patch</span><span class="o">.</span><span class="n">object</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="s2">&quot;client&quot;</span><span class="p">,</span> <span class="n">autospec</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span> <span class="k">as</span> <span class="n">m</span><span class="p">:</span>
        <span class="n">m</span><span class="o">.</span><span class="n">post</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="n">httpx</span><span class="o">.</span><span class="n">Response</span><span class="p">(</span>
            <span class="n">status_code</span><span class="o">=</span><span class="mi">201</span><span class="p">,</span>
            <span class="n">json</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;a&quot;</span><span class="p">:</span> <span class="s2">&quot;b&quot;</span><span class="p">},</span>
        <span class="p">)</span>
        <span class="k">yield</span> <span class="n">m</span>


<span class="k">def</span> <span class="nf">test_get</span><span class="p">(</span><span class="n">mock_get</span><span class="p">):</span>
    <span class="k">assert</span> <span class="n">get</span><span class="p">(</span><span class="s2">&quot;test_url&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="n">HTTPStatus</span><span class="o">.</span><span class="n">OK</span>
    <span class="n">mock_get</span><span class="o">.</span><span class="n">get</span><span class="o">.</span><span class="n">assert_called</span><span class="p">()</span>


<span class="k">def</span> <span class="nf">test_get</span><span class="p">(</span><span class="n">mock_post</span><span class="p">):</span>
    <span class="k">assert</span> <span class="n">post</span><span class="p">(</span><span class="s2">&quot;test_url&quot;</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="n">HTTPStatus</span><span class="o">.</span><span class="n">CREATED</span>
    <span class="n">mock_post</span><span class="o">.</span><span class="n">post</span><span class="o">.</span><span class="n">assert_called</span><span class="p">()</span>
</code></pre></div>

<p>The <code>get</code> and <code>post</code> function share a global dependency, the <code>client</code>. Also, these
functions have side effects—since they make external network calls. We'll have to mock
the functions in a way so that our tests are completely isolated and they don't make any
network calls. I mocked out the functions in the <code>mock_get</code> and <code>mock_post</code> fixtures
respectively. The functions are mocked in a way that whenever the original functions are
called in the mock scope, they'll return consistent values without making any network
call.</p>
<p>Since <code>client</code> was instantiated in the global scope, it had to be mocked using the
<code>patch.object(...)</code> interjector. Also, notice how the mocked-up <code>get</code> and <code>post</code>
functions' return-values mimic their orginal return-values. In the above case, the
fixture runs in the module scope, which implies, they'll only run once in the entire
test module. This makes the test session quicker. However, keep in mind that making
fixtures run in the module scope has also its demerits. Since the target functions get
mocked and stay mocked through the entire module, it can subtly create coupling between
your test functions if you aren't careful.</p>
<h2>References</h2>
<ul>
<li><a href="https://github.com/rednafi/reflections/issues/73">Test async code with pytest-asyncio</a></li>
<li><a href="https://docs.python.org/3/library/unittest.mock.html">Unittest mock — mock object library</a></li>
</ul>


             
 
            
            
            







            <hr/>
        </div>
        <section id="article-sidebar" class="span2">
            <h4>Published</h4>
            <time itemprop="dateCreated" datetime="2022-02-27T00:00:00+06:00">Sun 27 February 2022</time>
            <h4>Category</h4>
            <a class="category-link" href="./categories.html#python-ref">python</a>
            <h4>Tags</h4>
            <ul class="list-of-tags tags-in-article">
                <li><a href="./tags.html#python-ref">Python
                    <span class="superscript">58</span>
</a></li>
                <li><a href="./tags.html#testing-ref">Testing
                    <span class="superscript">3</span>
</a></li>
            </ul>
<h4>Contact</h4>
<div id="sidebar-social-link">
    <a href="mailto:redowan.nafi@gmail.com" title="" target="_blank" rel="nofollow noopener noreferrer">
        <svg xmlns="http://www.w3.org/2000/svg" aria-label="Mail" role="img" viewBox="0 0 512 512"><rect width="512" height="512" rx="15%" fill="#328cff"/><path d="m250 186c-46 0-69 35-69 74 0 44 29 72 68 72 43 0 73-32 73-75 0-44-34-71-72-71zm-1-37c30 0 57 13 77 33 0-22 35-22 35 1v150c-1 10 10 16 16 9 25-25 54-128-14-187-64-56-149-47-195-15-48 33-79 107-49 175 33 76 126 99 182 76 28-12 41 26 12 39-45 19-168 17-225-82-38-68-36-185 67-248 78-46 182-33 244 32 66 69 62 197-2 246-28 23-71 1-71-32v-11c-20 20-47 32-77 32-57 0-108-51-108-108 0-58 51-110 108-110" fill="#fff"/></svg>
    </a>
    <a href="https://github.com/rednafi" title="" target="_blank" rel="nofollow noopener noreferrer">
        <svg xmlns="http://www.w3.org/2000/svg" aria-label="GitHub" role="img" viewBox="0 0 512 512"><rect width="512" height="512" rx="15%" fill="#1B1817"/><path fill="#fff" d="M335 499c14 0 12 17 12 17H165s-2-17 12-17c13 0 16-6 16-12l-1-50c-71 16-86-28-86-28-12-30-28-37-28-37-24-16 1-16 1-16 26 2 40 26 40 26 22 39 59 28 74 22 2-17 9-28 16-35-57-6-116-28-116-126 0-28 10-51 26-69-3-6-11-32 3-67 0 0 21-7 70 26 42-12 86-12 128 0 49-33 70-26 70-26 14 35 6 61 3 67 16 18 26 41 26 69 0 98-60 120-117 126 10 8 18 24 18 48l-1 70c0 6 3 12 16 12z"/></svg>
    </a>
    <a href="https://twitter.com/rednafi" title="" target="_blank" rel="nofollow noopener noreferrer">
        <svg xmlns="http://www.w3.org/2000/svg" aria-label="Twitter" role="img" viewBox="0 0 512 512"><rect width="512" height="512" rx="15%" fill="#1da1f3"/><path fill="#fff" d="M437 152a72 72 0 0 1-40 12 72 72 0 0 0 32-40 72 72 0 0 1-45 17 72 72 0 0 0-122 65 200 200 0 0 1-145-74 72 72 0 0 0 22 94 72 72 0 0 1-32-7 72 72 0 0 0 56 69 72 72 0 0 1-32 1 72 72 0 0 0 67 50 200 200 0 0 1-105 29 200 200 0 0 0 309-179 200 200 0 0 0 35-37"/></svg>
    </a>
    <a href="https://www.goodreads.com/user/show/53485837-redowan-delowar" title="" target="_blank" rel="nofollow noopener noreferrer">
        <svg height="512" viewBox="0 0 512 512" width="512" xmlns="http://www.w3.org/2000/svg"><rect fill="#EAE6CF" height="512" rx="64" width="512"/><path d="m254.92444 336.92444c43.2889-.36 74.07112-22.01333 92.33334-64.95111h.95556v65.48889c0 4.88-.32 12.44889-.95556 22.73333-1.30222 10.64445-4.78222 22.10223-10.42666 34.36889-5.65778 11.54667-14.79112 21.38667-27.37778 29.49778-12.44889 8.84-29.81778 13.44-52.12001 13.80444-21.48444 0-39.65333-5.59555-54.52444-16.77777-15.2-11.00889-24.08001-28.87111-26.65778-53.58667h-18.89778c1.93778 32.11111 12.18667 55.02667 30.76444 68.74222 18.08889 13.16445 41.04001 19.75556 68.83556 19.75556 27.45778 0 48.87112-5.14223 64.21778-15.43111 15.18223-9.92 26.08445-22.28445 32.71556-37.08 6.62222-14.79111 10.58222-28.86667 11.86667-42.21334.98222-13.35555 1.45778-22.91555 1.45778-28.68889v-270.088875h-18.90667v59.537775h-.95556c-7.27555-21.82667-19.30666-38.333335-36.12-49.524445-16.96-11.00445-35.70222-16.51111-56.21333-16.51111-35.72001.72444-62.85779 14.52444-81.43112 41.40889-19.07111 26.697775-28.59556 59.631105-28.59556 98.782195 0 40.23557 9.04445 73.52001 27.13334 99.86224 18.27555 26.88889 45.89778 40.51111 82.90222 40.87111zm-68.34222-224.89777c14.85333-24.359995 37.63111-36.986665 68.34222-37.888885 31.50223.90666 54.83556 13.17333 70.03556 36.808885 15.18223 23.64 22.77778 52.05331 22.77778 85.25331s-7.59555 61.43112-22.77778 84.70668c-15.2 24.72444-38.53333 37.34667-70.03556 37.88889-29.72889-.54667-52.36-12.81778-67.86222-36.80889-15.67556-23.27556-23.50667-51.87112-23.50667-85.79112-.004-31.75556 7.67111-59.81332 23.02667-84.16887z" fill="#743901"/></svg>
    </a>
    <a href="/reflections/feeds/all.atom.xml" title="" target="_blank" rel="nofollow noopener noreferrer">
        <svg xmlns="http://www.w3.org/2000/svg" aria-label="RSS" role="img" viewBox="0 0 512 512"><rect width="512" height="512" rx="15%" fill="#f80"/><circle cx="145" cy="367" r="35" fill="#fff"/><path fill="none" stroke="#fff" stroke-width="60" d="M109 241c89 0 162 73 162 162M109 127c152 0 276 124 276 276"/></svg>
    </a>
</div>
            





            





        </section>
</div>
</article>
<!-- Root element of PhotoSwipe. Must have class pswp. -->
<div class="pswp" tabindex="-1" role="dialog" aria-hidden="true">

    <!-- Background of PhotoSwipe.
         It's a separate element as animating opacity is faster than rgba(). -->
    <div class="pswp__bg"></div>

    <!-- Slides wrapper with overflow:hidden. -->
    <div class="pswp__scroll-wrap">

        <!-- Container that holds slides.
            PhotoSwipe keeps only 3 of them in the DOM to save memory.
            Don't modify these 3 pswp__item elements, data is added later on. -->
        <div class="pswp__container">
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
        </div>

        <!-- Default (PhotoSwipeUI_Default) interface on top of sliding area. Can be changed. -->
        <div class="pswp__ui pswp__ui--hidden">

            <div class="pswp__top-bar">

                <!--  Controls are self-explanatory. Order can be changed. -->

                <div class="pswp__counter"></div>

                <button class="pswp__button pswp__button--close" title="Close (Esc)"></button>

                <button class="pswp__button pswp__button--share" title="Share"></button>

                <button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>

                <button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button>

                <!-- Preloader demo https://codepen.io/dimsemenov/pen/yyBWoR -->
                <!-- element will get class pswp__preloader--active when preloader is running -->
                <div class="pswp__preloader">
                    <div class="pswp__preloader__icn">
                      <div class="pswp__preloader__cut">
                        <div class="pswp__preloader__donut"></div>
                      </div>
                    </div>
                </div>
            </div>

            <div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap">
                <div class="pswp__share-tooltip"></div>
            </div>

            <button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
            </button>

            <button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)">
            </button>

            <div class="pswp__caption">
                <div class="pswp__caption__center"></div>
            </div>

        </div>

    </div>

</div>                    </div>
                    <div class="span1"></div>
                </div>
            </div>
        </div>
<footer>



    <div id="fpowered">

            © 2020-2022 • Redowan Delowar • All Rights Reserved


    </div>
</footer>            <script src="//code.jquery.com/jquery.min.js"></script>
        <script src="//netdna.bootstrapcdn.com/twitter-bootstrap/2.3.2/js/bootstrap.min.js"></script>
        <script src="./theme/js/elegant.prod.9e9d5ce754.js"></script>
        <script>
            function validateForm(query)
            {
                return (query.length > 0);
            }
        </script>

    <script>
    (function () {
        if (window.location.hash.match(/^#comment-\d+$/)) {
            $('#comment_thread').collapse('show');
        }
    })();
    window.onhashchange=function(){
        if (window.location.hash.match(/^#comment-\d+$/))
            window.location.reload(true);
    }
    $('#comment_thread').on('shown', function () {
        var link = document.getElementById('comment-accordion-toggle');
        var old_innerHTML = link.innerHTML;
        $(link).fadeOut(200, function() {
            $(this).text('Click here to hide comments').fadeIn(200);
        });
        $('#comment_thread').on('hidden', function () {
            $(link).fadeOut(200, function() {
                $(this).text(old_innerHTML).fadeIn(200);
            });
        })
    })
</script>

    </body>
    <!-- Theme: Elegant built for Pelican
        License : MIT -->
</html>